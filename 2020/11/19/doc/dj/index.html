<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Web框架本质-Django | 雪人</title><meta name="keywords" content="sql  python node  video web html css javascript"><meta name="author" content="雪人"><meta name="copyright" content="雪人"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="Web框架本质web系统概念 1. Http，无状态，短连接 2. 浏览器（socket客户端）、网站（socket服务端）   web框架本质 import socket def handle_request(client): buf &#x3D; client.recv(1024) client.send(&quot;HTTP&#x2F;1.1 200 OK\r\n\r\n&quot;) client.send(">
<meta property="og:type" content="article">
<meta property="og:title" content="Web框架本质-Django">
<meta property="og:url" content="https://www.webq.top/2020/11/19/doc/dj/index.html">
<meta property="og:site_name" content="雪人">
<meta property="og:description" content="Web框架本质web系统概念 1. Http，无状态，短连接 2. 浏览器（socket客户端）、网站（socket服务端）   web框架本质 import socket def handle_request(client): buf &#x3D; client.recv(1024) client.send(&quot;HTTP&#x2F;1.1 200 OK\r\n\r\n&quot;) client.send(">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://www.webq.top/img/hy.jpeg">
<meta property="article:published_time" content="2020-11-19T06:06:47.975Z">
<meta property="article:modified_time" content="2020-11-19T06:06:47.976Z">
<meta property="article:author" content="雪人">
<meta property="article:tag" content="sql  python node  video web html css javascript">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.webq.top/img/hy.jpeg"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://www.webq.top/2020/11/19/doc/dj/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="manifest" href="/pwa/manifest.json"/><link rel="apple-touch-icon" sizes="180x180" href="/pwa/favicon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/pwa/favicon.png"/><link rel="icon" type="image/png" sizes="16x16" href="/pwa/favicon.png"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-11-19 14:06:47'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/face.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">153</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">40</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">12</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 工具集</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/follow/"><i class="fa-fw fas fa-star"></i><span> 收藏夹</span></a></li><li><a class="site-page" href="/audio/"><i class="fa-fw fas fa-music"></i><span> audio_context</span></a></li><li><a class="site-page" href="/piano/"><i class="fa-fw fas fa-music"></i><span> 在线Piano</span></a></li><li><a class="site-page" href="/hy/"><i class="fa-fw fas fa-video"></i><span> Canvas绘图</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 文档库</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/2020/11/15/doc/ci/"><i class="fa-fw far fa-circle"></i><span> CI</span></a></li><li><a class="site-page" href="/2020/11/15/doc/h264/"><i class="fa-fw far fa-video"></i><span> h264</span></a></li><li><a class="site-page" href="/2020/11/15/doc/f4v/"><i class="fa-fw far fa-video"></i><span> f4v</span></a></li><li><a class="site-page" href="/2020/11/15/doc/mask/"><i class="fa-fw far fa-mask"></i><span> mask</span></a></li><li><a class="site-page" href="/2020/11/15/doc/dj/"><i class="fa-fw far fa-python"></i><span> Django</span></a></li><li><a class="site-page" href="/2020/11/15/doc/mse/"><i class="fa-fw far fa-buffer"></i><span> MSE</span></a></li></ul></div></div></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web%E6%A1%86%E6%9E%B6%E6%9C%AC%E8%B4%A8"><span class="toc-number">1.</span> <span class="toc-text">Web框架本质</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a2"><span class="toc-number">2.</span> <span class="toc-text">
django学员管理系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a3"><span class="toc-number">3.</span> <span class="toc-text">
动态路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a7"><span class="toc-number">4.</span> <span class="toc-text">
Django视图CBV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a8"><span class="toc-number">5.</span> <span class="toc-text">
ORM连表操作（一对多）（一对多中，外键存在于从表中）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a9"><span class="toc-number">6.</span> <span class="toc-text">
ORM连表操作（多对多）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a10"><span class="toc-number">7.</span> <span class="toc-text">
ORM连表操作（多对多自关联）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a11"><span class="toc-number">8.</span> <span class="toc-text">
ORM操作补充（models模块中数据表属性定义操作）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a12"><span class="toc-number">9.</span> <span class="toc-text">
分页查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a13"><span class="toc-number">10.</span> <span class="toc-text">
ORM补充之基本操作（数据行高级操作）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a14"><span class="toc-number">11.</span> <span class="toc-text">
XSS攻击（跨站脚本攻击）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a15"><span class="toc-number">12.</span> <span class="toc-text">
ORM函数相关（html模版上使用函数）simple_tag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a16"><span class="toc-number">13.</span> <span class="toc-text">
cookie和session（推荐使用session）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a17"><span class="toc-number">14.</span> <span class="toc-text">
用户登陆demo</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a19"><span class="toc-number">15.</span> <span class="toc-text">
Form组件完成学员管理系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a20"><span class="toc-number">16.</span> <span class="toc-text">
Form常用组件定制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a21"><span class="toc-number">17.</span> <span class="toc-text">
Form组件中的钩子（扩展自定义函数）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a22"><span class="toc-number">18.</span> <span class="toc-text">
Ajax提交数据部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a230"><span class="toc-number">19.</span> <span class="toc-text">
CORS解决跨域问题（跨来源资源共享）（响应头添加值）</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/img/hy.jpeg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">雪人</a></span><span id="menus"><div id="search_button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 工具集</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/follow/"><i class="fa-fw fas fa-star"></i><span> 收藏夹</span></a></li><li><a class="site-page" href="/audio/"><i class="fa-fw fas fa-music"></i><span> audio_context</span></a></li><li><a class="site-page" href="/piano/"><i class="fa-fw fas fa-music"></i><span> 在线Piano</span></a></li><li><a class="site-page" href="/hy/"><i class="fa-fw fas fa-video"></i><span> Canvas绘图</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-heartbeat"></i><span> 文档库</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/2020/11/15/doc/ci/"><i class="fa-fw far fa-circle"></i><span> CI</span></a></li><li><a class="site-page" href="/2020/11/15/doc/h264/"><i class="fa-fw far fa-video"></i><span> h264</span></a></li><li><a class="site-page" href="/2020/11/15/doc/f4v/"><i class="fa-fw far fa-video"></i><span> f4v</span></a></li><li><a class="site-page" href="/2020/11/15/doc/mask/"><i class="fa-fw far fa-mask"></i><span> mask</span></a></li><li><a class="site-page" href="/2020/11/15/doc/dj/"><i class="fa-fw far fa-python"></i><span> Django</span></a></li><li><a class="site-page" href="/2020/11/15/doc/mse/"><i class="fa-fw far fa-buffer"></i><span> MSE</span></a></li></ul></div></div><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Web框架本质-Django</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-19T06:06:47.975Z" title="发表于 2020-11-19 14:06:47">2020-11-19</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2020-11-19T06:06:47.976Z" title="更新于 2020-11-19 14:06:47">2020-11-19</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>64分钟</span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="Web框架本质"><a href="#Web框架本质" class="headerlink" title="Web框架本质"></a>Web框架本质</h2><p>web系统概念</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="number">1.</span> Http，无状态，短连接 </span><br><span class="line"><span class="number">2.</span> 浏览器（socket客户端）、网站（socket服务端）</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>web框架本质</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> socket </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_request</span>(<span class="params">client</span>):</span> </span><br><span class="line">buf = client.recv(<span class="number">1024</span>) </span><br><span class="line">client.send(<span class="string">&quot;HTTP/1.1 200 OK\r\n\r\n&quot;</span>) </span><br><span class="line">client.send(<span class="string">&quot;Hello, Seven&quot;</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span> </span><br><span class="line">sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) </span><br><span class="line">sock.bind((<span class="string">&#x27;localhost&#x27;</span>,<span class="number">8000</span>)) </span><br><span class="line">sock.listen(<span class="number">5</span>) <span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">connection, address = sock.accept() </span><br><span class="line">handle_request(connection) </span><br><span class="line">connection.close() <span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>自定义Web框架</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">a. socket服务端 </span><br><span class="line">b. 根据URL不同返回不同的内容 路由系统： URL -&gt; 函数 </span><br><span class="line">c. 字符串返回给用户 模板引擎渲染： HTML充当模板（特殊字符） 自己创造任意数据 字符串</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>静态网站处理方式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f1</span>(<span class="params">request</span>):</span> </span><br><span class="line"></span><br><span class="line">    <span class="comment"># #  处理用户请求，并返回相应的内容 :param request: 用户请求的所有信息 :return:  </span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;index.fsw&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) </span><br><span class="line">    data = f.read() </span><br><span class="line">    f.close() </span><br><span class="line">    <span class="keyword">return</span> data </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f2</span>(<span class="params">request</span>):</span> </span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;aricle.tpl&#x27;</span>,<span class="string">&#x27;rb&#x27;</span>) </span><br><span class="line">    data = f.read() </span><br><span class="line">    f.close() </span><br><span class="line">    <span class="keyword">return</span> data </span><br><span class="line"></span><br><span class="line">routers = [ </span><br><span class="line">    (<span class="string">&#x27;/xxx&#x27;</span>, f1), </span><br><span class="line">    (<span class="string">&#x27;/ooo&#x27;</span>, f2), </span><br><span class="line">] </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span> </span><br><span class="line">    sock = socket.socket() </span><br><span class="line">    sock.bind((<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">8080</span>)) </span><br><span class="line">    sock.listen(<span class="number">5</span>) </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">        conn,addr = sock.accept() <span class="comment"># hang住 # 有人来连接了 # 获取用户发送的数据 </span></span><br><span class="line">        data = conn.recv(<span class="number">8096</span>) </span><br><span class="line">        data = <span class="built_in">str</span>(data,encoding=<span class="string">&#x27;utf-8&#x27;</span>) </span><br><span class="line">        headers,bodys = data.split(<span class="string">&#x27;\r\n\r\n&#x27;</span>) </span><br><span class="line">        temp_list = headers.split(<span class="string">&#x27;\r\n&#x27;</span>) </span><br><span class="line">        method,url,protocal = temp_list[<span class="number">0</span>].split(<span class="string">&#x27; &#x27;</span>) </span><br><span class="line">        conn.send(<span class="string">b&quot;HTTP/1.1 200 OK\r\n\r\n&quot;</span>) </span><br><span class="line">        func_name = <span class="literal">None</span> <span class="keyword">for</span> item <span class="keyword">in</span> routers: </span><br><span class="line">        <span class="keyword">if</span> item[<span class="number">0</span>] == url: </span><br><span class="line">            func_name = item[<span class="number">1</span>] </span><br><span class="line">            <span class="keyword">break</span> </span><br><span class="line">        <span class="keyword">if</span> func_name: </span><br><span class="line">            response = func_name(data) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            response = <span class="string">b&quot;404&quot;</span> </span><br><span class="line">        conn.send(response) </span><br><span class="line">        conn.close() </span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>动态网站处理方式一（手动进行替换的模版引擎）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f3</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">import</span> pymysql <span class="comment"># 创建连接,获得数据 </span></span><br><span class="line">    conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;123&#x27;</span>,db=<span class="string">&#x27;db666&#x27;</span>) </span><br><span class="line">    cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">    cursor.execute(<span class="string">&#x27;select id,username,password from userinfo&#x27;</span>) </span><br><span class="line">    user_list = cursor.fetchall() </span><br><span class="line">    cursor.close() </span><br><span class="line">    conn.close() <span class="comment"># 组装数据模型 </span></span><br><span class="line">    content_list=[] </span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> user_list: </span><br><span class="line">        tp = <span class="string">&#x27;&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;&#x27;</span>%(row[<span class="string">&#x27;id&#x27;</span>],row[<span class="string">&#x27;username&#x27;</span>],row[<span class="string">&#x27;password&#x27;</span>]) </span><br><span class="line">        content_list.append(tp) </span><br><span class="line">        content = <span class="string">&quot;&quot;</span>.join(content_list) <span class="comment"># 将列表中的数据拼接成字符串 # 模板渲染（模板+数据） </span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;userlist.html&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) </span><br><span class="line">    template = f.read() </span><br><span class="line">    f.close() </span><br><span class="line">    data = template.replace(<span class="string">&#x27;@@sdfsdffd@@&#x27;</span>, content) </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>(data, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="comment"># 路由系统 </span></span><br><span class="line"></span><br><span class="line">routers = [ (<span class="string">&#x27;/userlist.htm&#x27;</span>, f3), ] </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>():</span> </span><br><span class="line">    sock = socket.socket() </span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>) </span><br><span class="line">    sock.bind((<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="number">8080</span>)) </span><br><span class="line">    sock.listen(<span class="number">5</span>) </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>: </span><br><span class="line">        conn,addr = sock.accept() <span class="comment"># hang住 # 有人来连接了 # 获取用户发送的数据 </span></span><br><span class="line">        data = conn.recv(<span class="number">8096</span>) </span><br><span class="line">        data = <span class="built_in">str</span>(data,encoding=<span class="string">&#x27;utf-8&#x27;</span>) </span><br><span class="line">        headers,bodys = data.split(<span class="string">&#x27;\r\n\r\n&#x27;</span>) </span><br><span class="line">        temp_list = headers.split(<span class="string">&#x27;\r\n&#x27;</span>) </span><br><span class="line">        method,url,protocal = temp_list[<span class="number">0</span>].split(<span class="string">&#x27; &#x27;</span>) </span><br><span class="line">        conn.send(<span class="string">b&quot;HTTP/1.1 200 OK\r\n\r\n&quot;</span>) </span><br><span class="line">        func_name = <span class="literal">None</span> </span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> routers: </span><br><span class="line">            <span class="keyword">if</span> item[<span class="number">0</span>] == url: </span><br><span class="line">                func_name = item[<span class="number">1</span>] </span><br><span class="line">                <span class="keyword">break</span> </span><br><span class="line">            <span class="keyword">if</span> func_name: </span><br><span class="line">                response = func_name(data) </span><br><span class="line">            <span class="keyword">else</span>: </span><br><span class="line">                response = <span class="string">b&quot;404&quot;</span> </span><br><span class="line"></span><br><span class="line">        conn.send(response) </span><br><span class="line">        conn.close() </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>: run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django项目前期配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">pip3 install django # 创建Django程序 </span><br><span class="line">django-admin startproject mysite # 进入程序目录 </span><br><span class="line">cd mysite # 启动socket服务端，等待用户发送请求 </span><br><span class="line">python manage.py runserver 127.0.0.1:8080</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django配置文件：</p>
<p>settings.py </p>
<p>…… </p>
<p>DIRS’: [os.path.join(BASE_DIR, ‘template’)], </p>
<p>……</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">Mysql数据库： </span><br><span class="line">DATABASES = &#123; </span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123; </span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>:<span class="string">&#x27;dbname&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;root&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">#备注： </span></span><br><span class="line"><span class="comment"># 由于Django内部连接MySQL时使用的是MySQLdb模块，而python3中还无此模块，所以需要使用pymysql来代替 </span></span><br><span class="line"><span class="comment"># 如下设置放置的与project同名的配置的 __init__.py文件中 </span></span><br><span class="line"><span class="keyword">import</span> pymysql </span><br><span class="line">pymysql.install_as_MySQLdb()　</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>静态文件路径： static目录 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span> </span><br><span class="line">STATICFILES_DIRS = ( os.path.join(BASE_DIR,<span class="string">&#x27;static&#x27;</span>), )</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>额外配置（跨站请求伪装crsf）: </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    …… </span><br><span class="line">    <span class="comment">#&#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;, </span></span><br><span class="line">    …… </span><br><span class="line">    ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>项目案例</p>
<p>网站请求</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls.py </span></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    <span class="comment"># url(r&#x27;^admin/&#x27;, admin.site.urls), </span></span><br><span class="line">    url(<span class="string">r&#x27;^index/&#x27;</span>,index), </span><br><span class="line">] <span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span> </span><br><span class="line"><span class="comment"># return HttpResponse(&#x27;Index&#x27;) </span></span><br><span class="line"><span class="keyword">return</span> render(request, <span class="string">&#x27;index.html&#x27;</span>,&#123; </span><br><span class="line">    <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;tom&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;users&#x27;</span>:[<span class="string">&#x27;李志&#x27;</span>,<span class="string">&#x27;李杰&#x27;</span>], </span><br><span class="line">    <span class="string">&#x27;user_dict&#x27;</span>:&#123;</span><br><span class="line">        <span class="string">&#x27;k1&#x27;</span>:<span class="string">&#x27;v1&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;k2&#x27;</span>:<span class="string">&#x27;v2&#x27;</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">&#x27;user_list_dict&#x27;</span>:[ &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;name&#x27;</span>:</span><br><span class="line">        <span class="string">&#x27;tom&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;tom@1231.com&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;tom&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;tom@1231.com&#x27;</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">        <span class="string">&#x27;id&#x27;</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;tom&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;tom@1231.com&#x27;</span></span><br><span class="line">    &#125;, </span><br><span class="line">] </span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>网站登陆</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls from django.conf.urls </span></span><br><span class="line"><span class="keyword">import</span> url <span class="keyword">from</span> django.contrib </span><br><span class="line"><span class="keyword">import</span> admin <span class="keyword">from</span> django.shortcuts </span><br><span class="line"><span class="keyword">import</span> HttpResponse,render,redirect </span><br><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    <span class="comment"># url(r&#x27;^admin/&#x27;, admin.site.urls), </span></span><br><span class="line">    url(<span class="string">r&#x27;^login/&#x27;</span>,login), </span><br><span class="line">] </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment"># #  处理用户请求，并返回内容 :param request: 用户请求相关的所有信息（对象） :return:  # 字符串 # </span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;&lt;input type=&quot;text&quot; /&gt;&#x27;</span>) </span><br><span class="line">    <span class="comment"># return HttpResponse(&#x27;login.html&#x27;) </span></span><br><span class="line">    <span class="comment"># 自动找到模板路径下的login.html文件，读取内容并返回给用户 </span></span><br><span class="line">    <span class="comment"># 模板路径的配置 print(request.GET) </span></span><br><span class="line">    <span class="comment"># 结果为字典格式，值为列表类型 if request.method == &quot;GET&quot;: return render(request,&#x27;login.html&#x27;) else: </span></span><br><span class="line">    <span class="comment"># 用户POST提交的数据（请求体） u = request.POST.get(&#x27;user&#x27;) p = request.POST.get(&#x27;pwd&#x27;) if u == &#x27;root&#x27; and p == &#x27;123&#x27;: </span></span><br><span class="line">    <span class="comment"># 登录成功 </span></span><br><span class="line">    <span class="comment"># return redirect(&#x27;http://www.oldboyedu.com&#x27;) return redirect(&#x27;/index/&#x27;) </span></span><br><span class="line">    <span class="comment"># 重定向 else: </span></span><br><span class="line">    <span class="comment"># 登录失败 return render(request,&#x27;login.html&#x27;,&#123;&#x27;msg&#x27;: &#x27;用户名或密码错误&#x27;&#125;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a2">
<a id="django_473"></a>django学员管理系统</h2>


<p>数据库设计结构</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">表结构：班级\学生\老师 （班级表）： </span><br><span class="line"><span class="built_in">id</span>          title </span><br><span class="line"><span class="number">1</span>           全<span class="number">4</span>期 </span><br><span class="line"><span class="number">2</span>           全<span class="number">5</span>期 </span><br><span class="line">学生表）： </span><br><span class="line"><span class="built_in">id</span>          name        班级ID（FK） </span><br><span class="line"><span class="number">1</span>           张杰            <span class="number">1</span> </span><br><span class="line">老师表）： </span><br><span class="line"><span class="built_in">id</span>          name </span><br><span class="line"><span class="number">1</span>           林峰 </span><br><span class="line"><span class="number">2</span>           林狗 </span><br><span class="line"><span class="number">3</span>           苑天 </span><br><span class="line">老师班级关系表）： </span><br><span class="line"><span class="built_in">id</span>          老师ID         班级ID </span><br><span class="line"><span class="number">1</span>           <span class="number">1</span>               <span class="number">1</span> </span><br><span class="line"><span class="number">2</span>           <span class="number">1</span>               <span class="number">2</span> </span><br><span class="line"><span class="number">3</span>           <span class="number">2</span>               <span class="number">2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>班级管理模块</p>
<p>查(母版继承)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    <span class="comment"># url(r&#x27;^admin/&#x27;, admin.site.urls), </span></span><br><span class="line">    url(<span class="string">r&#x27;classes/&#x27;</span>, views.classes), </span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># view from django.shortcuts </span></span><br><span class="line"><span class="keyword">import</span> render,redirect </span><br><span class="line"><span class="keyword">import</span> pymysql </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classes</span>(<span class="params">request</span>):</span> </span><br><span class="line">    conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;123&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">    cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">    <span class="comment"># 设置查询结果为字典格式 </span></span><br><span class="line">    cursor.execute(<span class="string">&quot;select id, title from class&quot;</span>) </span><br><span class="line">    class_list = cursor.fetchall() </span><br><span class="line">    <span class="comment"># 结果为字典 </span></span><br><span class="line">    cursor.close() </span><br><span class="line">    conn.close() </span><br><span class="line">    print(class_list) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;classes.html&#x27;</span>,&#123;<span class="string">&#x27;class_list&#x27;</span>:class_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    <span class="comment"># url(r&#x27;^admin/&#x27;, admin.site.urls), </span></span><br><span class="line">    url(<span class="string">r&#x27;^add_class/&#x27;</span>, views.add_class), </span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># view </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_class</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;add_class.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        print(request.POST) </span><br><span class="line">        v = request.POST.get(<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">        conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">3306</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd=<span class="string">&#x27;123&#x27;</span>,db=<span class="string">&#x27;s4db65&#x27;</span>,charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">        cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">        cursor.execute(<span class="string">&#x27;insert into class(title) value(%s)&#x27;</span>, [v,]) </span><br><span class="line">        conn.commit() </span><br><span class="line">        <span class="comment"># 提交事务 </span></span><br><span class="line">        cursor.close() </span><br><span class="line">        conn.close() </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/classes/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    url(<span class="string">r&#x27;^del_class/&#x27;</span>, views.del_class),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># view </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">del_class</span>(<span class="params">request</span>):</span> </span><br><span class="line">    nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">    conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;123&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">    cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">    cursor.execute(<span class="string">&#x27;delete from class where id=%s&#x27;</span>,[nid,]) </span><br><span class="line">    conn.commit() </span><br><span class="line">    cursor.close() </span><br><span class="line">    conn.close() </span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;/classes/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">urlpatterns = [ url(<span class="string">r&#x27;^edit_class/&#x27;</span>, views.edit_class), ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># view </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_class</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="comment"># 获取数据 </span></span><br><span class="line">        nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">        conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">3306</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd = <span class="string">&#x27;123&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>,charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">        cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">        cursor.execute(<span class="string">&#x27;select id, title from class where id=%s&#x27;</span>, [nid,]) </span><br><span class="line">        result = cursor.fetchone() </span><br><span class="line">        cursor.close() </span><br><span class="line">        conn.close() </span><br><span class="line">        print(result) </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_class.html&#x27;</span>,&#123;<span class="string">&#x27;result&#x27;</span>:result&#125;) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">        title = request.POST.get(<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">        print(nid, title) </span><br><span class="line">        conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">3306</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd=<span class="string">&#x27;123&#x27;</span>,db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">        cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">        cursor.execute(<span class="string">&#x27;update class set title=%s where id=%s&#x27;</span>,[title,nid,]) conn.commit() cursor.close() conn.close() </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/classes/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>模态对话框实现增加班级功能</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">urlpatterns = [url(<span class="string">r&#x27;^modal_add_class/&#x27;</span>, views.modal_add_class]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views sqlheper工具类（将增删改查进行封装）： </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span>(<span class="params">sql,args</span>):</span> </span><br><span class="line">    conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;123&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">    cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) cursor.execute(sql,args) </span><br><span class="line">    conn.commit() </span><br><span class="line">    cursor.close() </span><br><span class="line">    conn.close() </span><br><span class="line">    ---------- </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modal_add_class</span>(<span class="params">request</span>):</span> </span><br><span class="line">    title = request.POST.get(<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(title) &gt; <span class="number">0</span>: </span><br><span class="line">        sqlheper.modify(<span class="string">&#x27;insert into class (title) value(%s)&#x27;</span>,[title,]) </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;ok&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;班级标题不能为空&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>学生管理模块</p>
<p>查</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^students/&#x27;</span>,views.students),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">students</span>(<span class="params">request</span>):</span> </span><br><span class="line">    conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">3306</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd=<span class="string">&#x27;123&#x27;</span>,db=<span class="string">&#x27;s4db65&#x27;</span>,charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">    cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">    cursor.execute(<span class="string">&#x27;select student.id,student.name,class.title from student left JOIN class on student.class_id = class.id&#x27;</span>) </span><br><span class="line">    student_list = cursor.fetchall() </span><br><span class="line">    cursor.close() </span><br><span class="line">    conn.close() </span><br><span class="line">    print(<span class="string">&#x27;结果：&#x27;</span>,student_list) </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;students.html&#x27;</span>,&#123;<span class="string">&#x27;student_list&#x27;</span>:student_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^add_student/&#x27;</span>,views.add_student)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_student</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="comment">#只负责跳转页面 </span></span><br><span class="line">        conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">3306</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd=<span class="string">&#x27;123&#x27;</span>,db=<span class="string">&#x27;s4db65&#x27;</span>,charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">        cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">        cursor.execute(<span class="string">&#x27;select id,title from class&#x27;</span>) </span><br><span class="line">        class_list = cursor.fetchall() </span><br><span class="line">        cursor.close() </span><br><span class="line">        conn.close() </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;add_student.html&#x27;</span>,&#123;<span class="string">&#x27;class_list&#x27;</span>:class_list&#125;) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        name = request.POST.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        <span class="comment">#负责提交数据的跳转页面 </span></span><br><span class="line">        class_id = request.POST.get(<span class="string">&#x27;class_id&#x27;</span>) </span><br><span class="line">        conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>,port=<span class="number">3306</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd=<span class="string">&#x27;123&#x27;</span>,db=<span class="string">&#x27;s4db65&#x27;</span>,charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">        cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">        cursor.execute(<span class="string">&#x27;insert into student(name,class_id)values(%s,%s)&#x27;</span>,[name,class_id,]) </span><br><span class="line">        conn.commit() </span><br><span class="line">        cursor.close() </span><br><span class="line">        conn.close() </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/students/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^edit_student/&#x27;</span>,views.edit_student),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="keyword">from</span> utils <span class="keyword">import</span> sqlheper </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_student</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">        nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">        class_list = sqlheper.get_list(<span class="string">&quot;select id,title from class&quot;</span>,[]) </span><br><span class="line">        current_student_info = sqlheper.get_one(<span class="string">&#x27;select id,name,class_id from student where id=%s&#x27;</span>,[nid,]) </span><br><span class="line">        print(<span class="string">&#x27;结果：&#x27;</span>,class_list,current_student_info,nid) </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_student.html&#x27;</span>,&#123;<span class="string">&#x27;class_list&#x27;</span>: class_list,<span class="string">&#x27;current_student_info&#x27;</span>:current_student_info&#125;) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">        name = request.POST.get(<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line">        class_id = request.POST.get(<span class="string">&#x27;class_id&#x27;</span>) </span><br><span class="line">        sqlheper.modify(<span class="string">&#x27;update student set name=%s,class_id=%s where id=%s&#x27;</span>,[name,class_id,nid,]) </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/students/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>模态对话框实现增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^modal_add_student/&#x27;</span>, views.modal_add_student),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modal_add_student</span>(<span class="params">request</span>):</span> </span><br><span class="line">    ret = &#123;<span class="string">&#x27;status&#x27;</span>:<span class="literal">True</span>,<span class="string">&#x27;message&#x27;</span>:<span class="literal">None</span>&#125; </span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        name = request.POST.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        print(<span class="string">&#x27;result&#x27;</span>,name) </span><br><span class="line">        class_id = request.POST.get(<span class="string">&#x27;class_id&#x27;</span>) </span><br><span class="line">        sqlheper.modify(<span class="string">&#x27;insert into student (name,class_id)values(%s,%s)&#x27;</span>,[name,class_id,]) </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: </span><br><span class="line">        ret[<span class="string">&#x27;status&#x27;</span>]=<span class="literal">False</span> </span><br><span class="line">        ret[<span class="string">&#x27;message&#x27;</span>]=<span class="built_in">str</span>[e] </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(ret))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>模态对话框实现改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^modal_edit_student/&#x27;</span>, views.modal_edit_student),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modal_edit_student</span>(<span class="params">request</span>):</span> </span><br><span class="line">    ret = &#123;<span class="string">&#x27;status&#x27;</span>: <span class="literal">True</span>,<span class="string">&#x27;message&#x27;</span>: <span class="literal">None</span>&#125; </span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        nid = request.POST.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">        name = request.POST.get(<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line">        class_id = request.POST.get(<span class="string">&#x27;class_id&#x27;</span>) </span><br><span class="line">        sqlheper.modify(<span class="string">&#x27;update student set name=%s,class_id=%s where id=%s&#x27;</span>,[name,class_id,nid,]) </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: </span><br><span class="line">        ret[<span class="string">&#x27;status&#x27;</span>] = <span class="literal">False</span> </span><br><span class="line">        ret[<span class="string">&#x27;message&#x27;</span>] = <span class="built_in">str</span>(e) </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(ret))</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老师管理模块</p>
<p>查</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^teachers/&#x27;</span>, views.teachers),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="comment"># 多对多，以老师表展示 </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">teachers</span>(<span class="params">request</span>):</span> </span><br><span class="line">    teacher_list = sqlheper.get_list(<span class="string">&#x27;select id,name from teacher&#x27;</span>,[]) </span><br><span class="line">    teacher_list = sqlheper.get_list(</span><br><span class="line">        <span class="comment">#  select teacher.id as tid,teacher.name,class.title from teacher </span></span><br><span class="line">                LEFT JOIN teacher2class on teacher.<span class="built_in">id</span> = teacher2class.teacher_id </span><br><span class="line">                <span class="comment"># left JOIN class on class.id = teacher2class.class_id; ,[]) </span></span><br><span class="line">    print(teacher_list) </span><br><span class="line">    result = &#123;&#125; </span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> teacher_list: </span><br><span class="line">        tid =row[<span class="string">&#x27;tid&#x27;</span>] </span><br><span class="line">        <span class="keyword">if</span> tid <span class="keyword">in</span> result: </span><br><span class="line">            result[tid][<span class="string">&#x27;titles&#x27;</span>].append(row[<span class="string">&#x27;title&#x27;</span>]) </span><br><span class="line">        lse: </span><br><span class="line">            result[tid] = &#123;<span class="string">&#x27;tid&#x27;</span>: row[<span class="string">&#x27;tid&#x27;</span>],<span class="string">&#x27;name&#x27;</span>:row[<span class="string">&#x27;name&#x27;</span>],<span class="string">&#x27;titles&#x27;</span>: [row[<span class="string">&#x27;title&#x27;</span>],]&#125; </span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;teacher.html&#x27;</span>,&#123;<span class="string">&#x27;teacher_list&#x27;</span>:result.values()&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># ursl </span></span><br><span class="line">url(<span class="string">r&#x27;^add_teacher/&#x27;</span>, views.add_teacher),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_teacher</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">        class_list = sqlheper.get_list(<span class="string">&#x27;select id,title from class&#x27;</span>,[]) </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;add_teacher.html&#x27;</span>,&#123;<span class="string">&#x27;class_list&#x27;</span>: class_list&#125;) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        name = request.POST.get(<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line">        <span class="comment"># 老师表中添加一条数据 </span></span><br><span class="line">        teacher_id = sqlheper.create(<span class="string">&#x27;insert into teacher(name) values(%s)&#x27;</span>,[name,]) </span><br><span class="line">        <span class="comment"># 老师和班级关系表中插入数据 </span></span><br><span class="line">        class_ids = request.POST.getlist(<span class="string">&#x27;class_ids&#x27;</span>) </span><br><span class="line">        <span class="comment"># 一次连接，一次提交 data_list = [] </span></span><br><span class="line">        <span class="keyword">for</span> cls_id <span class="keyword">in</span> class_ids: </span><br><span class="line">            temp = (teacher_id,cls_id,) </span><br><span class="line">            data_list.append(temp) </span><br><span class="line">            obj = sqlheper.SqlHelper() </span><br><span class="line">            <span class="comment"># 通过自定义的mysql组件获得mysql连接对象 </span></span><br><span class="line">            obj.multiple_modify(<span class="string">&#x27;insert into teacher2class(teacher_id,class_id) values(%s,%s)&#x27;</span>,data_list) obj.close() </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/teachers/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^edit_teacher/&#x27;</span>,views.edit_teacher),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_teacher</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">        nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">        obj = sqlheper.SqlHelper() </span><br><span class="line">        teacher_info = obj.get_one(<span class="string">&#x27;select id,name from teacher where id =%s&#x27;</span>,[nid,]) </span><br><span class="line">        class_id_list = obj.get_list(<span class="string">&#x27;select class_id from teacher2class where teacher_id=%s&#x27;</span>,[nid,]) </span><br><span class="line">        class_list = obj.get_list(<span class="string">&#x27;select id,title from class&#x27;</span>,[]) </span><br><span class="line">        obj.close() </span><br><span class="line">        print(<span class="string">&#x27;当前老师信息&#x27;</span>,teacher_info) </span><br><span class="line">        print(<span class="string">&#x27;当前老师任教的班级id&#x27;</span>,class_id_list) </span><br><span class="line">        temp = [] </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> class_id_list: </span><br><span class="line">            temp.append(i[<span class="string">&#x27;class_id&#x27;</span>]) </span><br><span class="line">            print(<span class="string">&#x27;所有班级&#x27;</span>,class_list) </span><br><span class="line">            <span class="comment"># return HttpResponse(&#x27;...&#x27;) </span></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_teacher.html&#x27;</span>,&#123; <span class="string">&#x27;teacher_info&#x27;</span>: teacher_info, <span class="string">&#x27;class_id_list&#x27;</span>: temp, <span class="string">&#x27;class_list&#x27;</span>: class_list, &#125;) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            nid = request.GET.get(<span class="string">&#x27;nid&#x27;</span>) </span><br><span class="line">            name = request.POST.get(<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line">            class_ids = request.POST.getlist(<span class="string">&#x27;class_ids&#x27;</span>) </span><br><span class="line">            obj = sqlheper.SqlHelper() </span><br><span class="line">            <span class="comment"># 更新老师表 </span></span><br><span class="line">            obj.modify(<span class="string">&#x27;update teacher set name=%s where id=%s&#x27;</span>,[name,nid]) </span><br><span class="line">            <span class="comment"># 更新老师和班级关系表 </span></span><br><span class="line">            <span class="comment"># 先把当前老师和班级的对应关系删除，然后再添加 </span></span><br><span class="line">            obj.modify(<span class="string">&#x27;delete from teacher2class where teacher_id=%s&#x27;</span>,[nid,]) </span><br><span class="line">            data_list = [] </span><br><span class="line">            <span class="keyword">for</span> cls_id <span class="keyword">in</span> class_ids: </span><br><span class="line">                temp = (nid,cls_id,) </span><br><span class="line">                data_list.append(temp) </span><br><span class="line">                obj = sqlheper.SqlHelper() </span><br><span class="line">                obj.multiple_modify(<span class="string">&#x27;insert into teacher2class(teacher_id,class_id) values(%s,%s)&#x27;</span>,data_list) </span><br><span class="line">                </span><br><span class="line">                obj.close() </span><br><span class="line">            </span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">&#x27;/teachers/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>模态对话框增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^get_all_class/&#x27;</span>, views.get_all_class), </span><br><span class="line">url(<span class="string">r&#x27;^modal_add_teacher/&#x27;</span>, views.modal_add_teacher),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_all_class</span>(<span class="params">request</span>):</span> </span><br><span class="line">    obj = sqlheper.SqlHelper() </span><br><span class="line">    class_list = obj.get_list(<span class="string">&#x27;select id,title from class&#x27;</span>,[]) </span><br><span class="line">    <span class="keyword">return</span> HttpResponse(json.dumps(class_list)) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modal_add_teacher</span>(<span class="params">request</span>):</span> </span><br><span class="line">    ret = &#123;<span class="string">&#x27;status&#x27;</span>: <span class="literal">True</span>,<span class="string">&#x27;message&#x27;</span>: <span class="literal">None</span>&#125; </span><br><span class="line">    <span class="keyword">try</span>: </span><br><span class="line">        name = request.POST.get(<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line">        class_id_list = request.POST.getlist(<span class="string">&#x27;class_id_list&#x27;</span>) </span><br><span class="line">        teacher_id = sqlheper.create(<span class="string">&#x27;insert into teacher(name) values(%s)&#x27;</span>,[name,]) </span><br><span class="line">        data_list = [] </span><br><span class="line">        <span class="keyword">for</span> cls_id <span class="keyword">in</span> class_id_list: </span><br><span class="line">            temp = (teacher_id,cls_id,) </span><br><span class="line">            data_list.append(temp) </span><br><span class="line">            obj = sqlheper.SqlHelper() </span><br><span class="line">            obj.multiple_modify(<span class="string">&#x27;insert into teacher2class(teacher_id,class_id) values(%s,%s)&#x27;</span>,data_list) </span><br><span class="line">            obj.close() </span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e: </span><br><span class="line">        ret[<span class="string">&#x27;status&#x27;</span>] = <span class="literal">False</span> </span><br><span class="line">        ret[<span class="string">&#x27;message&#x27;</span>] = <span class="string">&quot;处理失败&quot;</span> </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(json.dumps(ret))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># sqlheper </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">sql,args</span>):</span> </span><br><span class="line">    conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">    cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">    cursor.execute(sql,args) </span><br><span class="line">    conn.commit() </span><br><span class="line">    last_row_id = cursor.lastrowid </span><br><span class="line">    cursor.close() </span><br><span class="line">    conn.close() </span><br><span class="line">    <span class="keyword">return</span> last_row_id </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SqlHelper</span>(<span class="params"><span class="built_in">object</span></span>):</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span> </span><br><span class="line">        self.connect() </span><br><span class="line">        <span class="comment"># 读取配置文件 </span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span> </span><br><span class="line">            self.conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">            self.cursor = self.conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">multiple_modify</span>(<span class="params">self,sql,args</span>):</span> </span><br><span class="line">            self.cursor.executemany(sql,args) </span><br><span class="line">            self.conn.commit() </span><br><span class="line">            </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span> </span><br><span class="line">            self.cursor.close() </span><br><span class="line">            self.conn.close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>用户登陆(包含cookies内容)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls </span></span><br><span class="line">url(<span class="string">r&#x27;^login/&#x27;</span>, views.login),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        user = request.POST.get(<span class="string">&#x27;username&#x27;</span>) </span><br><span class="line">        pwd = request.POST.get(<span class="string">&#x27;password&#x27;</span>) </span><br><span class="line">        <span class="keyword">if</span> user == <span class="string">&#x27;tom&#x27;</span> <span class="keyword">and</span> pwd == <span class="string">&#x27;123&#x27;</span>: </span><br><span class="line">            obj = redirect(<span class="string">&#x27;/classes/&#x27;</span>) </span><br><span class="line">            obj.set_signed_cookie(<span class="string">&#x27;ticket&#x27;</span>,<span class="string">&quot;567&quot;</span>,salt=<span class="string">&#x27;jjjjjj&#x27;</span>,max_age=<span class="number">900</span>,path=<span class="string">&#x27;/&#x27;</span>) </span><br><span class="line">            <span class="comment"># 设置cookies，浏览器的cookies中会直接以明文显示567 </span></span><br><span class="line">            <span class="keyword">return</span> obj </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>) </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">classes</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment"># 去请求的cookie中找凭证 </span></span><br><span class="line">    <span class="comment"># tk = request.COOKIES.get(&#x27;ticket&#x27;) </span></span><br><span class="line">    tk = request.get_signed_cookie(<span class="string">&#x27;ticket&#x27;</span>,salt=<span class="string">&#x27;jjjjjj&#x27;</span>) </span><br><span class="line">    print(tk) </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> tk: </span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">&#x27;/login/&#x27;</span>) </span><br><span class="line"></span><br><span class="line">conn = pymysql.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">3306</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;&#x27;</span>, db=<span class="string">&#x27;s4db65&#x27;</span>, charset=<span class="string">&#x27;utf8&#x27;</span>) </span><br><span class="line">cursor = conn.cursor(cursor=pymysql.cursors.DictCursor) </span><br><span class="line">cursor.execute(<span class="string">&quot;select id,title from class&quot;</span>) </span><br><span class="line">class_list = cursor.fetchall() </span><br><span class="line">cursor.close() </span><br><span class="line">conn.close() </span><br><span class="line"><span class="keyword">return</span> render(request, <span class="string">&#x27;classes.html&#x27;</span>, &#123;<span class="string">&#x27;class_list&#x27;</span>: class_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 内容延伸 装饰器装饰views中的函数 @xzxx </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span> </span><br><span class="line">    obj = HttpResponse(<span class="string">&#x27;...&#x27;</span>) </span><br><span class="line">    obj.set_cookie(.....) </span><br><span class="line">    request.COOKIES.get(...) </span><br><span class="line">    obj.set_signed_cookie(.....) </span><br><span class="line">    request.get_signed_cookie(....)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a3">
<a id="_1707"></a>动态路由</h2>


<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 动态路由 </span></span><br><span class="line"><span class="comment"># url(r&#x27;^edit/(\w+)/(\w+)/&#x27;, views.edit), </span></span><br><span class="line"><span class="comment"># url(r&#x27;^edit/(?P&lt;a1&gt;\w+)/(?P&lt;a2&gt;\w+)/&#x27;, views.edit), </span></span><br><span class="line"><span class="comment"># url(r&#x27;^edit/(\w+).html$&#x27;, views.edit) </span></span><br><span class="line"><span class="comment">#正则表达式实现静态伪装</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">request,*args,**kwargs</span>):</span></span><br><span class="line">    <span class="comment">#获得请求数据 </span></span><br><span class="line">    print(args,kwargs) </span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>路由分发</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">＃路由分发实现不同模块分开编辑，团队协作开发 </span><br><span class="line">url(<span class="string">r&#x27;^app01/&#x27;</span>, include(<span class="string">&#x27;app01.urls&#x27;</span>)),　</span><br><span class="line"><span class="comment">#不同的程序模块 </span></span><br><span class="line">url(<span class="string">r&#x27;^app02/&#x27;</span>, include(<span class="string">&#x27;app02.urls&#x27;</span>)), </span><br><span class="line"><span class="comment"># url(r&#x27;^&#x27;, default), </span></span><br><span class="line"><span class="comment"># 设置默认页面，接收任意请求 </span></span><br><span class="line"><span class="comment"># url(r&#x27;^&#x27;, views.index), #</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>反向生成URL（Django独有）</p>
<p>通过别名反射成URL，简化URL的填写， 用于权限管理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#urls </span></span><br><span class="line">url(<span class="string">r&#x27;^edit/(\w+)/(\w+)/&#x27;</span>, views.edit,name=<span class="string">&#x27;n2&#x27;</span>),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ORM基本操作（数据表+数据行操作</p>
<p>操作前的配置步骤</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">__init__.py文件 (ORM默认使用SQLlite连接数据库,需改成Mysql) </span><br><span class="line">添加： </span><br><span class="line"><span class="keyword">import</span> pymysql </span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在mysql中手动创建数据库</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 配置setting文件中重写数数据库配置 </span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">…… </span><br><span class="line"><span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR,<span class="string">&#x27;templates&#x27;</span>)],</span><br><span class="line">…… </span><br><span class="line">] </span><br><span class="line">DATABASES = &#123; </span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123; </span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>:<span class="string">&#x27;s4day70db&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;root&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;localhost&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="number">3306</span>, </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>操作表</p>
<p>创建表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># models </span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="comment"># 在数据库中的表名为模块名_UserInfo </span></span><br><span class="line">    nid = models.BigAutoField(primary_key=<span class="literal">True</span>) </span><br><span class="line">    <span class="comment">#可不写，默认会生成表中的id字段 </span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># settings配置文件中安装app01模块 I</span></span><br><span class="line">NSTALLED_APPS = [ </span><br><span class="line">    …… </span><br><span class="line">    <span class="string">&#x27;app01&#x27;</span>, </span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 执行语句 </span></span><br><span class="line"><span class="comment">#生成数据表配置文件，包含生成及修改等信息 </span></span><br><span class="line">python manage.py makemigrations </span><br><span class="line"></span><br><span class="line"><span class="comment">#执行生成的配置文件</span></span><br><span class="line">python manage.py migrate </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改表：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># models </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    …… </span><br><span class="line">    age = models.IntegerField(default=<span class="number">1</span>) </span><br><span class="line">    <span class="comment"># 新增字段时需设置默认值/允许为空 </span></span><br><span class="line">    <span class="comment"># age = models.IntegerField(null=True)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 执行语句：</span></span><br><span class="line"><span class="comment">#生成数据表配置文件，包含生成及修改等信息 </span></span><br><span class="line">python manage.py makemigrations </span><br><span class="line"></span><br><span class="line"><span class="comment">#执行生成的配置文件</span></span><br><span class="line">python manage.py migrate </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>删除表：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参考修改表</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建外键关联：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># models </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserGroup</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    <span class="comment">#等同于主表，需将该类写在子表前面 </span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    <span class="comment"># 外键所在的表等同于子表 </span></span><br><span class="line">    …… </span><br><span class="line">    ug = models.ForeignKey(<span class="string">&#x27;UserGroup&#x27;</span>,null=<span class="literal">True</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    <span class="comment"># 外键关联字段关联UserGroup表中的Id字段，ug在UserInfo数据表中的字段为ug_id</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>操作单表数据行：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 增 </span></span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models </span><br><span class="line">models.UserGroup.objects.create(title=<span class="string">&#x27;销售部&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 删 </span></span><br><span class="line">models.UserGroup.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">2</span>).delete()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 改 </span></span><br><span class="line">models.UserGroup.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">2</span>).update(title=<span class="string">&#x27;公关部&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 查 </span></span><br><span class="line">group_list = models.UserGroup.objects.<span class="built_in">all</span>() </span><br><span class="line">group_list = models.UserGroup.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">1</span>) </span><br><span class="line"></span><br><span class="line">group_list = models.UserGroup.objects.<span class="built_in">filter</span>(id__gt=<span class="number">1</span>) <span class="comment">#大于1 </span></span><br><span class="line">group_list = models.UserGroup.objects.<span class="built_in">filter</span>(id__lt=<span class="number">1</span>) <span class="comment">#小于1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a7">
<a id="DjangoCBV_1907"></a>Django视图CBV</h2>


<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^login.html$&#x27;</span>, views.Login.as_view),</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">View</span>):</span> </span><br><span class="line">    <span class="comment"># 继承View类作为父类 # </span></span><br><span class="line">    <span class="comment">#重写父类方法，该方法可作为装饰器功能 </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span> </span><br><span class="line">        <span class="comment"># 自定制 dispatch方法，除了可以利用父类中原dispatch方法，还可以自定制处理逻辑 </span></span><br><span class="line">        print(<span class="string">&#x27;before&#x27;</span>) </span><br><span class="line">        obj = <span class="built_in">super</span>(Login,self).dispatch(request, *args, **kwargs) </span><br><span class="line">        <span class="comment"># 传入Login对象作为参数，调用父类中的方法 </span></span><br><span class="line">        print(<span class="string">&#x27;after&#x27;</span>) </span><br><span class="line">        <span class="keyword">return</span> obj </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span> </span><br><span class="line">        <span class="comment"># 请求为get请求时，自动调用该方法 </span></span><br><span class="line">        <span class="comment"># return HttpResponse(&#x27;Login.get&#x27;) </span></span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>) </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="comment"># 请求是POST请求时，自动调用该方法 </span></span><br><span class="line">        print(request.POST.get(<span class="string">&#x27;user&#x27;</span>)) </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;Login.post&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a8">
<a id="ORM_1948"></a>ORM连表操作（一对多）（一对多中，外键存在于从表中）</h2>


<p>models</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserType</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    <span class="comment"># 用户类型 </span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">     用户表 </span><br><span class="line">    name = models.CharField(max_length=<span class="number">16</span>) </span><br><span class="line">    age = models.IntegerField() </span><br><span class="line">    ut = models.ForeignKey(<span class="string">&#x27;UserType&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    <span class="comment"># 关联UserType表中的id字段</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^test.html$&#x27;</span>, views.test),</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 创建数据 </span></span><br><span class="line"><span class="comment"># models.UserType.objects.create(title=&#x27;普通用户&#x27;) </span></span><br><span class="line"><span class="comment"># models.UserType.objects.create(title=&#x27;二逼用户&#x27;) </span></span><br><span class="line"><span class="comment"># models.UserType.objects.create(title=&#x27;牛逼用户&#x27;)</span></span><br><span class="line"><span class="comment"># models.UserInfo.objects.create(name=&#x27;方少伟&#x27;,age=18,ut_id=1) </span></span><br><span class="line"><span class="comment"># models.UserInfo.objects.create(name=&#x27;由秦兵&#x27;,age=18,ut_id=2) </span></span><br><span class="line"><span class="comment"># models.UserInfo.objects.create(name=&#x27;刘庚&#x27;,age=18,ut_id=2) </span></span><br><span class="line"><span class="comment"># models.UserInfo.objects.create(name=&#x27;陈涛&#x27;,age=18,ut_id=3) </span></span><br><span class="line"><span class="comment"># models.UserInfo.objects.create(name=&#x27;王者&#x27;,age=18,ut_id=3) </span></span><br><span class="line"><span class="comment"># models.UserInfo.objects.create(name=&#x27;杨涵&#x27;,age=18,ut_id=1)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一对多的正向操作（让存在外键的从表进行跨表，去查询关联主表中的字段）：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获得Queryset对象格式数据（格式：对象名.外键字段名.关联表字段名） </span></span><br><span class="line">obj = models.UserInfo.objects.<span class="built_in">all</span>().first() </span><br><span class="line"><span class="comment"># 获取一条数据，无需再obj[0]来获取具体的对象 </span></span><br><span class="line">print(obj.name,obj.age,obj.ut.title) </span><br><span class="line"><span class="comment"># 获取跨表后的字段用obj.ut.title方式，ut是外键关联中的字段</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获得查询结果为字典格式组合成列表类型的Queryset数据,可用list方法转换成列表格式（从表中的外键字段名__主表中的字段名） </span></span><br><span class="line">v1 = models.UserInfo.objects.values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;ut__title&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获得查询结果为元组格式组合成列表类型的Queryset数据,可用List转换成列表（从表中的外键字段名__主表中的字段名） </span></span><br><span class="line">result = models.UserInfo.objects.<span class="built_in">all</span>().values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>.<span class="string">&#x27;ut__title&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一对多的反向操作(让主表进行跨表，去查询（有外键关联字段）从表中相应的字段作为查询条件或查询结果)：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获得Queryset对象格式的数据,(格式：主表的QuerySet对象名.从表名__set.all()) （一个用户类型下可以有很多用户，获得所有用户类型对应的用户信息数据）： </span></span><br><span class="line">obj = models.UserType.objects.<span class="built_in">all</span>().first() </span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> obj.userinfo_set.<span class="built_in">all</span>(): </span><br><span class="line">    print(row.name,row.age)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获得字典格式Queryset对象格式的数据,需要转换成json字符串格式通过ajax返回数据时，可用list方法转换成列表（从表表名小写__主表字段名） </span></span><br><span class="line">v2 = models.UserType.objects.values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;userinfo__name&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 获得元组格式Queryset对象格式的数据,需要转换成json字符串格式通过ajax返回数据时，可用list方法转换成列表。（外键字段名__从表字段名） </span></span><br><span class="line">result = models.UserType.objects.<span class="built_in">all</span>().values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;userinfo__name&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一对多其他参考：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 跨表 </span></span><br><span class="line"><span class="comment"># 正向查询： </span></span><br><span class="line"><span class="number">1.</span> </span><br><span class="line">    q = UserInfo.objects.<span class="built_in">all</span>().first() </span><br><span class="line">    q.ug.title </span><br><span class="line"><span class="number">2.</span> </span><br><span class="line">    UserInfo.objects.values(<span class="string">&#x27;nid&#x27;</span>,<span class="string">&#x27;ug_id&#x27;</span>) </span><br><span class="line">    UserInfo.objects.values(<span class="string">&#x27;nid&#x27;</span>,<span class="string">&#x27;ug_id&#x27;</span>,<span class="string">&#x27;ug__title&#x27;</span>) </span><br><span class="line"><span class="number">3.</span> </span><br><span class="line">    UserInfo.objects.values_list(<span class="string">&#x27;nid&#x27;</span>,<span class="string">&#x27;ug_id&#x27;</span>,<span class="string">&#x27;ug__title&#x27;</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 反向查询： </span></span><br><span class="line"><span class="number">1.</span> 小写的表名_set </span><br><span class="line">    obj = UserGroup.objects.<span class="built_in">all</span>().first() </span><br><span class="line">    result = obj.userinfo_set.<span class="built_in">all</span>() [userinfo对象,userinfo对象,] </span><br><span class="line"><span class="number">2.</span> 小写的表名 </span><br><span class="line">    v = UserGroup.objects.values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">    v = UserGroup.objects.values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;小写的从表名称&#x27;</span>) </span><br><span class="line">    v = UserGroup.objects.values(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;小写的从表名称__age&#x27;</span>) </span><br><span class="line"><span class="number">3.</span> 小写的表名 </span><br><span class="line">    v = UserGroup.objects.values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">    v = UserGroup.objects.values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;小写的表名称&#x27;</span>) </span><br><span class="line">    v = UserGroup.objects.values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;小写的表名称__age&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a9">
<a id="ORM_2066"></a>ORM连表操作（多对多）</h2>

<p>（多对多中，主表与从表的外键都共同存在于第3张关联表中） ##</p>
<p>手动创建第三张关联表（推荐，手动更灵活）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># models </span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boy</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Girl</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    nick = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Love</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    b = models.ForeignKey(<span class="string">&#x27;Boy&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    g = models.ForeignKey(<span class="string">&#x27;Girl&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </span><br><span class="line">        <span class="comment">#添加联合唯一字段 </span></span><br><span class="line">        unique_together = [ (<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;g&#x27;</span>), ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="comment"># 添加数据 </span></span><br><span class="line">objs = [ </span><br><span class="line">    models.Boy(name=<span class="string">&#x27;方少伟&#x27;</span>), </span><br><span class="line">    models.Boy(name=<span class="string">&#x27;由秦兵&#x27;</span>), </span><br><span class="line">    models.Boy(name=<span class="string">&#x27;陈涛&#x27;</span>), </span><br><span class="line">    models.Boy(name=<span class="string">&#x27;闫龙&#x27;</span>), </span><br><span class="line">    models.Boy(name=<span class="string">&#x27;吴彦祖&#x27;</span>), </span><br><span class="line">] </span><br><span class="line">models.Boy.objects.bulk_create(objs,<span class="number">5</span>) </span><br><span class="line"><span class="comment"># 批量添加数据 </span></span><br><span class="line">objss = [ </span><br><span class="line">    models.Girl(nick=<span class="string">&#x27;小鱼&#x27;</span>), </span><br><span class="line">    models.Girl(nick=<span class="string">&#x27;小周&#x27;</span>), </span><br><span class="line">    models.Girl(nick=<span class="string">&#x27;小猫&#x27;</span>), </span><br><span class="line">    models.Girl(nick=<span class="string">&#x27;小狗&#x27;</span>), </span><br><span class="line">] </span><br><span class="line">models.Girl.objects.bulk_create(objss,<span class="number">5</span>) </span><br><span class="line"><span class="comment"># 1. 查询和方少伟有关系的姑娘 </span></span><br><span class="line"><span class="comment"># 第一种查询方式：跨表反向查询，获得对象 </span></span><br><span class="line"><span class="comment"># obj = models.Boy.objects.filter(name=&#x27;方少伟&#x27;).first() </span></span><br><span class="line"><span class="comment"># love_list = obj.love_set.all() </span></span><br><span class="line"><span class="comment"># 反向查询，获得所有love表中的对象 </span></span><br><span class="line"><span class="comment"># for row in love_list: </span></span><br><span class="line"><span class="comment"># print(row.g.nick) </span></span><br><span class="line"><span class="comment"># 获得对应的姑娘数据 </span></span><br><span class="line"><span class="comment"># 第二种查询方式：连表查询（正向查询），直接查询love表，获得对象 </span></span><br><span class="line"><span class="comment"># love_list = models.Love.objects.filter(b__name=&#x27;方少伟&#x27;) </span></span><br><span class="line"><span class="comment">#获得Queryset对象 </span></span><br><span class="line"><span class="comment"># for row in love_list: </span></span><br><span class="line"><span class="comment"># print(row.g.nick) </span></span><br><span class="line"><span class="comment"># （推荐）第三种查询方式：只发送一次sql连接请求，获得字典,属于正向查询 </span></span><br><span class="line"><span class="comment"># love_list = models.Love.objects.filter(b__name=&#x27;方少伟&#x27;).values(&#x27;g__nick&#x27;) # for item in love_list: </span></span><br><span class="line"><span class="comment"># 获得字典格式的列表，[&#123;&#x27;g__nick&#x27;:&#x27;xxx&#125;,] # print(item[&#x27;g__nick&#x27;]) </span></span><br><span class="line"><span class="comment"># （推荐）第四种查询方式：相当于inner join方式连表查询，只发送一次sql连接请求，获得对象 </span></span><br><span class="line"><span class="comment"># love_list = models.Love.objects.filter(b__name=&#x27;方少伟&#x27;).select_related(&#x27;g&#x27;) </span></span><br><span class="line"><span class="comment"># for obj in love_list: </span></span><br><span class="line"><span class="comment"># 获得对象 </span></span><br><span class="line"><span class="comment"># print(obj.g.nick) </span></span><br><span class="line"><span class="comment"># 总结：多对多都是先获得关联表中的数据，再进行跨表操作 </span></span><br><span class="line"><span class="comment"># 对象格式用.（点）进行跨表 字典和元组采用_（双下划线）进行跨表</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Django自动生成第三张关联表（无法再手动添加其它字段）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># models </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boy</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    m = models.ManyToManyField(<span class="string">&#x27;Girl&#x27;</span>) </span><br><span class="line"><span class="comment">#自动生成关联表m，以两张表中的id字段作为关联字段 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Girl</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    nick = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="comment"># 增 </span></span><br><span class="line"><span class="comment"># obj = models.Boy.objects.filter(name=&#x27;方少伟&#x27;).first() </span></span><br><span class="line"><span class="comment"># obj.m.add(2) </span></span><br><span class="line"><span class="comment"># obj.m.add(2,4) </span></span><br><span class="line"><span class="comment"># 创建关联表的多条数据 </span></span><br><span class="line"><span class="comment"># obj.m.add(*[1,3]) </span></span><br><span class="line"><span class="comment"># 以列表形式创建多条数据 </span></span><br><span class="line"><span class="comment"># 删 </span></span><br><span class="line"><span class="comment"># obj.m.remove(1) </span></span><br><span class="line"><span class="comment"># obj.m.remove(2,3) </span></span><br><span class="line"><span class="comment"># 删除关联表的多条数据 </span></span><br><span class="line"><span class="comment"># obj.m.remove(*[4,]) </span></span><br><span class="line"><span class="comment"># obj.m.set([1,]) </span></span><br><span class="line"><span class="comment"># 覆盖数据库所有数据,重置 </span></span><br><span class="line"><span class="comment"># obj = models.Boy.objects.filter(name=&#x27;方少伟&#x27;).first() </span></span><br><span class="line"><span class="comment"># obj.m.clear() </span></span><br><span class="line"><span class="comment"># 删除所有与方少伟的关联数据 </span></span><br><span class="line"><span class="comment"># 查 </span></span><br><span class="line"><span class="comment"># 正向查询出单条数据 </span></span><br><span class="line"><span class="comment"># obj = models.Boy.objects.filter(name=&#x27;方少伟&#x27;).first() </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># girl_list = obj.m.all() </span></span><br><span class="line"><span class="comment"># girl_list = obj.m.filter(nick=&#x27;小鱼&#x27;) </span></span><br><span class="line"><span class="comment"># 相当于从从表跨表到主表查询 </span></span><br><span class="line"><span class="comment"># print(girl_list) </span></span><br><span class="line"><span class="comment"># 反向查询出多条数据 </span></span><br><span class="line"><span class="comment"># obj = models.Girl.objects.filter(nick=&#x27;小鱼&#x27;).first() </span></span><br><span class="line"><span class="comment"># print(obj.id,obj.nick) </span></span><br><span class="line"><span class="comment"># boy_list = obj.boy_set.all() </span></span><br><span class="line"><span class="comment"># 相当于从主表跨表到从表反向查询</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>手动与自动结合</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># models </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boy</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    m = models.ManyToManyField(to=<span class="string">&#x27;Girl&#x27;</span>,through=<span class="string">&quot;Love&quot;</span>,through_fields=(<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;g&#x27;</span>,)) </span><br><span class="line"><span class="comment"># 可不写to关键字 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Girl</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    nick = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Love</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    b = models.ForeignKey(<span class="string">&#x27;Boy&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    g = models.ForeignKey(<span class="string">&#x27;Girl&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> unique_together = [ (<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;g&#x27;</span>), ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line">obj = models.Boy.objects.<span class="built_in">filter</span>(name=<span class="string">&#x27;方少伟&#x27;</span>).first() </span><br><span class="line">obj.m.add(<span class="number">1</span>) </span><br><span class="line"><span class="comment"># obj.m.remove(1) </span></span><br><span class="line"><span class="comment"># obj.m.clear() 可以 v = obj.m.all() print(v)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a10">
<a id="ORM_2219"></a>ORM连表操作（多对多自关联）</h2>

<p>原理：等同于复制出一张新表</p>
<p>models</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    nickname = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>) </span><br><span class="line">    gender_choices = ( (<span class="number">1</span>,<span class="string">&#x27;男&#x27;</span>), (<span class="number">2</span>,<span class="string">&#x27;女&#x27;</span>), ) </span><br><span class="line">    gender = models.IntegerField(choices=gender_choices) </span><br><span class="line">    m = models.ManyToManyField(<span class="string">&#x27;UserInfo&#x27;</span>) </span><br><span class="line"><span class="comment"># 多对多自关联字段，自动生成第二张表，字段分别为from_userinfo_id和to_userinfo_id; </span></span><br><span class="line"><span class="comment"># 表中的m属性不会在userinfo表中生成m字段</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">request</span>):</span> </span><br><span class="line"><span class="comment"># 查男生（通过m字段查询属于正向操作） </span></span><br><span class="line">xz = models.UserInfo.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">1</span>).first() </span><br><span class="line"><span class="comment">#id为1代表男生的1条数据 </span></span><br><span class="line">u = xz.m.<span class="built_in">all</span>() <span class="keyword">for</span> row <span class="keyword">in</span> u: print(row.nickname) </span><br><span class="line"><span class="comment"># 查女生(通过表名称_set查询属于反向操作) </span></span><br><span class="line">xz = models.UserInfo.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">4</span>).first() </span><br><span class="line"><span class="comment">#id为4代表女生的1条数据 </span></span><br><span class="line">v = xz.userinfo_set.<span class="built_in">all</span>() </span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> v: </span><br><span class="line">    print(row.nickname) </span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> HttpResponse(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>外键自关联（常用于评论表功能）</p>
<p>等同于复制出一张新表，用原表中的外键作连表操作</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    <span class="comment"># #  评论表  </span></span><br><span class="line">    <span class="comment"># 新闻ID </span></span><br><span class="line">    news_id = models.IntegerField() </span><br><span class="line">    <span class="comment"># 评论内容 </span></span><br><span class="line">    content = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    <span class="comment"># 评论者 </span></span><br><span class="line">    user = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    <span class="comment">#related_name表示反向查询时，代替 表名_set 和 表名__字段名 </span></span><br><span class="line">    reply = models.ForeignKey(<span class="string">&#x27;Comment&#x27;</span>,null=<span class="literal">True</span>,blank=<span class="literal">True</span>,related_name=<span class="string">&#x27;xxxx&#x27;</span>) </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    新闻ID                        reply_id </span><br><span class="line">    <span class="number">1</span>           别比比 root         null </span><br><span class="line">    <span class="number">1</span>           就比比 root         null </span><br><span class="line">    <span class="number">1</span>           瞎比比 shaowei      null </span><br><span class="line">    <span class="number">2</span>           写的正好 root       null </span><br><span class="line">    <span class="number">1</span>           拉倒吧 由清滨         <span class="number">2</span> </span><br><span class="line">    <span class="number">1</span>           拉倒吧<span class="number">1</span> xxxxx        <span class="number">2</span> </span><br><span class="line">    <span class="number">1</span>           拉倒吧<span class="number">2</span> xxxxx       <span class="number">5</span> </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    新闻<span class="number">1</span> </span><br><span class="line">        别比比 </span><br><span class="line">        就比比 </span><br><span class="line">            - 拉倒吧 </span><br><span class="line">            - 拉倒吧<span class="number">2</span> </span><br><span class="line">        - 拉倒吧<span class="number">1</span> </span><br><span class="line">        瞎比比 </span><br><span class="line">        </span><br><span class="line">    新闻<span class="number">2</span>： </span><br><span class="line">        写的正好 </span><br><span class="line">    <span class="comment"># </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a11">
<a id="ORMmodels_2294"></a>ORM操作补充（models模块中数据表属性定义操作）</h2>


<p>models</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models </span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> RegexValidator </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserAdmin</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    email = models.EmailField(</span><br><span class="line">        ull=<span class="literal">True</span>,</span><br><span class="line">        default=<span class="string">&#x27;111&#x27;</span>, </span><br><span class="line">        db_index=<span class="literal">True</span>,</span><br><span class="line">        unique=<span class="literal">True</span>, </span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        verbose_name=<span class="string">&#x27;邮箱&#x27;</span>, </span><br><span class="line">        editable=<span class="literal">True</span>, </span><br><span class="line">        help_text=<span class="string">&#x27;字段提示信息的内容&#x27;</span>, </span><br><span class="line">    ) </span><br><span class="line"><span class="comment"># blank控制admin是否为空， </span></span><br><span class="line">file = models.FileField() </span><br><span class="line"><span class="comment">#文件字段，只针对admin </span></span><br><span class="line">ctime = models.DateTimeField() </span><br><span class="line"><span class="comment"># 日期字段 </span></span><br><span class="line"><span class="comment"># 自定义正则表达式验证规则 </span></span><br><span class="line">test = models.CharField(</span><br><span class="line">    max_length=<span class="number">32</span>, </span><br><span class="line">    error_messages=&#123; <span class="string">&#x27;c1&#x27;</span>: <span class="string">&#x27;优先错信息1&#x27;</span>, &#125;, </span><br><span class="line">    validators=[RegexValidator(regex=<span class="string">&#x27;root_\d+&#x27;</span>, message=<span class="string">&#x27;错误了&#x27;</span>, code=<span class="string">&#x27;c1&#x27;</span>)], </span><br><span class="line">    null=<span class="literal">True</span> </span><br><span class="line">) </span><br><span class="line"><span class="comment"># 数字及小数 </span></span><br><span class="line"><span class="comment"># num = models.FloatField() </span></span><br><span class="line"><span class="comment"># num = models.IntegerField() </span></span><br><span class="line">num = models.DecimalField(max_digits=<span class="number">30</span>,decimal_places=<span class="number">10</span>) </span><br><span class="line"><span class="comment"># 总长度为30，小数点后面10位 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 枚举 c</span></span><br><span class="line">olor_list = ( </span><br><span class="line">    (<span class="number">1</span>,<span class="string">&#x27;黑色&#x27;</span>), </span><br><span class="line">    (<span class="number">2</span>,<span class="string">&#x27;白色&#x27;</span>), </span><br><span class="line">    (<span class="number">3</span>,<span class="string">&#x27;蓝色&#x27;</span>)</span><br><span class="line">) </span><br><span class="line">color = models.IntegerField(choices=color_list) </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </span><br><span class="line">    unique_together=( </span><br><span class="line">        (<span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;username&#x27;</span>)  <span class="comment"># 字段联合唯一索引 </span></span><br><span class="line">) </span><br><span class="line">index_together=( </span><br><span class="line">    (<span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;username&#x27;</span>)   <span class="comment"># 联合索引，不做约束限制 </span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">的∂</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># admin模块 </span></span><br><span class="line"><span class="keyword">from</span> django.contrib </span><br><span class="line"><span class="keyword">import</span> admin <span class="keyword">from</span> app01 </span><br><span class="line"><span class="keyword">import</span> models admin.site.register(models.UserAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a12">
<a id="_2356"></a>分页查询</h2>


<p>内置分页函数</p>
<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^index.html$&#x27;</span>, views.index),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.core.paginator </span><br><span class="line"><span class="keyword">import</span> Paginator,Page,PageNotAnInteger,EmptyPage </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span> </span><br><span class="line">    user_list = models.UserInfo.objects.<span class="built_in">all</span>() </span><br><span class="line"><span class="comment">#获得所有数据库数据 </span></span><br><span class="line">paginator = Paginator(user_list,<span class="number">10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">#设置每页显示的总条数 </span></span><br><span class="line">current_page = request.GET.get(<span class="string">&#x27;page&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获得当前页数 </span></span><br><span class="line"><span class="keyword">try</span>: </span><br><span class="line">    <span class="comment">#设置当前页数对应的数据 </span></span><br><span class="line">    posts = paginator.page(current_page) </span><br><span class="line"><span class="keyword">except</span> PageNotAnInteger <span class="keyword">as</span> e: </span><br><span class="line">    <span class="comment">#当前页面数非整数 </span></span><br><span class="line">    posts = paginator.page(<span class="number">1</span>) </span><br><span class="line"><span class="keyword">except</span> EmptyPage <span class="keyword">as</span> e: </span><br><span class="line">    <span class="comment">#当前页码数为空 </span></span><br><span class="line">    posts = paginator.page(<span class="number">1</span>) </span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> render(request,<span class="string">&#x27;index.html&#x27;</span>,&#123;<span class="string">&#x27;posts&#x27;</span>:posts&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="a13">
<a id="ORM_2521"></a>ORM补充之基本操作（数据行高级操作）</h2>


<p>排序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">user_list = models.UserInfo.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;-id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line"><span class="comment"># —id代表降序，id代表升序</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>分组</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db.models </span><br><span class="line"><span class="keyword">import</span> Count,Sum,Max,Min </span><br><span class="line">v =models.UserInfo.objects.values(<span class="string">&#x27;ut_id&#x27;</span>).annotate(xxxx=Count(<span class="string">&#x27;id&#x27;</span>)) </span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">    SELECT </span><br><span class="line">        `app01_userinfo`.`ut_id`, COUNT(`app01_userinfo`.`<span class="built_in">id</span>`) AS `xxxx` </span><br><span class="line">    FROM </span><br><span class="line">        `app01_userinfo` </span><br><span class="line">    GROUP BY </span><br><span class="line">        `app01_userinfo`.`ut_id` </span><br><span class="line">    ORDER BY </span><br><span class="line">        NULL</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 带有having 分组条件过滤 </span></span><br><span class="line">v =models.UserInfo.objects.values(<span class="string">&#x27;ut_id&#x27;</span>).annotate(xxxx=Count(<span class="string">&#x27;id&#x27;</span>)).<span class="built_in">filter</span>(xxxx__gt=<span class="number">2</span>) </span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">    SELECT </span><br><span class="line">        `app01_userinfo`.`ut_id`, COUNT(`app01_userinfo`.`<span class="built_in">id</span>`) AS `xxxx` </span><br><span class="line">    FROM </span><br><span class="line">        `app01_userinfo` </span><br><span class="line">    GROUP BY </span><br><span class="line">        `app01_userinfo`.`ut_id` </span><br><span class="line">    HAVING </span><br><span class="line">        COUNT(`app01_userinfo`.`<span class="built_in">id</span>`) &gt; <span class="number">2</span> </span><br><span class="line">    ORDER BY </span><br><span class="line">        NULL</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">v =models.UserInfo.objects.<span class="built_in">filter</span>(id__gt=<span class="number">2</span>).values(<span class="string">&#x27;ut_id&#x27;</span>).annotate(xxxx=Count(<span class="string">&#x27;id&#x27;</span>)).<span class="built_in">filter</span>(xxxx__gt=<span class="number">2</span>) </span><br><span class="line"><span class="comment"># 等价于</span></span><br><span class="line">    SELECT </span><br><span class="line">        `app01_userinfo`.`ut_id`, COUNT(`app01_userinfo`.`<span class="built_in">id</span>`) AS `xxxx` </span><br><span class="line">    FROM </span><br><span class="line">        `app01_userinfo` </span><br><span class="line">    WHERE </span><br><span class="line">        `app01_userinfo`.`<span class="built_in">id</span>` &gt; <span class="number">2</span> </span><br><span class="line">    GROUP BY </span><br><span class="line">        `app01_userinfo`.`ut_id` </span><br><span class="line">    HAVING </span><br><span class="line">        COUNT(`app01_userinfo`.`<span class="built_in">id</span>`) &gt; <span class="number">2</span> </span><br><span class="line">    ORDER BY </span><br><span class="line">        NULL</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">分组格式：model.类名.objects.values(显示的字段名).annotate(作为字段查结结果的别名=Count(字段<span class="built_in">id</span>/<span class="number">1</span>)) </span><br><span class="line"><span class="comment"># annotate依赖于values</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>条件过滤</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">models.UserInfo.objects.<span class="built_in">filter</span>(id__gt=<span class="number">1</span>) <span class="comment"># id&gt;1 </span></span><br><span class="line">……（id__lt=<span class="number">1</span>） <span class="comment"># id&lt;1 </span></span><br><span class="line">……(id__lte=<span class="number">1</span>) <span class="comment"># id&lt;=1 </span></span><br><span class="line">……(id__gte=<span class="number">1</span>) <span class="comment"># id&gt;=1 </span></span><br><span class="line">……(id__in=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]) <span class="comment"># id in [1,2,3] </span></span><br><span class="line">……(name__startswith=<span class="string">&#x27;xxxx&#x27;</span>) <span class="comment"># </span></span><br><span class="line">……(name__contains=<span class="string">&#x27;xxxx&#x27;</span>) <span class="comment"># </span></span><br><span class="line">……exclude(<span class="built_in">id</span>=<span class="number">1</span>) <span class="comment"># </span></span><br><span class="line"><span class="keyword">not</span> <span class="keyword">in</span> (<span class="built_in">id</span>=<span class="number">1</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>F,Q,extra方法</p>
<p>F</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F </span><br><span class="line">models.UserInfo.objects.<span class="built_in">all</span>().update(age=F(<span class="string">&quot;age&quot;</span>)+<span class="number">1</span>) </span><br><span class="line"><span class="comment"># F()用来取对象中某列值</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Q(构造复杂的查询条件)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 对象方式(不推荐) </span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q </span><br><span class="line">models.UserInfo.objects.<span class="built_in">filter</span>(Q(id__gt=<span class="number">1</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment"># or </span></span><br><span class="line">models.UserInfo.objects.<span class="built_in">filter</span>(Q(<span class="built_in">id</span>=<span class="number">8</span>) | Q(<span class="built_in">id</span>=<span class="number">2</span>)) </span><br><span class="line"></span><br><span class="line"><span class="comment"># and</span></span><br><span class="line">models.UserInfo.objects.<span class="built_in">filter</span>(Q(<span class="built_in">id</span>=<span class="number">8</span>) &amp; Q(<span class="built_in">id</span>=<span class="number">2</span>)) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>方法方式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q </span><br><span class="line">q1 = Q() </span><br><span class="line">q1.connector = <span class="string">&#x27;OR&#x27;</span> </span><br><span class="line">q1.children.append((<span class="string">&#x27;id__gt&#x27;</span>, <span class="number">1</span>)) </span><br><span class="line">q1.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">10</span>)) </span><br><span class="line"><span class="comment"># 通过OR将3个条件进行连接组装 </span></span><br><span class="line">q2 = Q() </span><br><span class="line">q2.connector = <span class="string">&#x27;OR&#x27;</span> </span><br><span class="line">q2.children.append((<span class="string">&#x27;c1&#x27;</span>, <span class="number">1</span>)) </span><br><span class="line">q2.children.append((<span class="string">&#x27;c1&#x27;</span>, <span class="number">10</span>)) </span><br><span class="line">q3 = Q() q3.connector = <span class="string">&#x27;AND&#x27;</span> </span><br><span class="line"><span class="comment">#通过AND将2个条件进行连接组装 </span></span><br><span class="line">q3.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">1</span>)) </span><br><span class="line">q3.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">2</span>)) </span><br><span class="line">q1.add(q3,<span class="string">&#x27;OR&#x27;</span>) </span><br><span class="line"><span class="comment">#还可将q3嵌入到q1条件组中 </span></span><br><span class="line"><span class="comment"># 将q1和q2条件组通过AND汇总到一起，q1和q2内部分别用or组合条件 </span></span><br><span class="line">con = Q() </span><br><span class="line">con.add(q1, <span class="string">&#x27;AND&#x27;</span>) </span><br><span class="line">con.add(q2, <span class="string">&#x27;AND&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>方法方式实际应用（多条件组合查询时）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">condition_dict = &#123; <span class="comment">#用户将选择的条件组合成字典格式 </span></span><br><span class="line">    <span class="string">&#x27;k1&#x27;</span>:[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>], </span><br><span class="line">    <span class="string">&#x27;k2&#x27;</span>:[<span class="number">1</span>,], </span><br><span class="line">&#125; </span><br><span class="line">con = Q() </span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> condition_dict.items(): </span><br><span class="line">    q = Q() </span><br><span class="line">    q.connector = <span class="string">&#x27;OR&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v: </span><br><span class="line">    q.children.append((<span class="string">&#x27;id&#x27;</span>, i)) </span><br><span class="line">    con.add(q,<span class="string">&#x27;AND&#x27;</span>) </span><br><span class="line"></span><br><span class="line">models.UserInfo.objects.<span class="built_in">filter</span>(con)</span><br><span class="line">*********************************************************************** </span><br><span class="line">q1 = Q() </span><br><span class="line">q1.connector = <span class="string">&#x27;OR&#x27;</span> </span><br><span class="line">q1.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">1</span>)) </span><br><span class="line">q1.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">10</span>)) </span><br><span class="line">q1.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">9</span>)) </span><br><span class="line">q2 = Q() </span><br><span class="line">q2.connector = <span class="string">&#x27;OR&#x27;</span> </span><br><span class="line">q2.children.append((<span class="string">&#x27;c1&#x27;</span>, <span class="number">1</span>)) </span><br><span class="line">q2.children.append((<span class="string">&#x27;c1&#x27;</span>, <span class="number">10</span>)) </span><br><span class="line">q2.children.append((<span class="string">&#x27;c1&#x27;</span>, <span class="number">9</span>)) </span><br><span class="line">q3 = Q() </span><br><span class="line">q3.connector = <span class="string">&#x27;AND&#x27;</span> </span><br><span class="line">q3.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">1</span>)) </span><br><span class="line">q3.children.append((<span class="string">&#x27;id&#x27;</span>, <span class="number">2</span>)) </span><br><span class="line">q1.add(q3,<span class="string">&#x27;OR&#x27;</span>) </span><br><span class="line">con = Q() </span><br><span class="line">con.add(q1, <span class="string">&#x27;AND&#x27;</span>) </span><br><span class="line">con.add(q2, <span class="string">&#x27;AND&#x27;</span>) </span><br><span class="line"><span class="comment">#以上构造结果等介于(id=1 or id = 10 or id=9 or (id=1 and id=2)) and (c1=1 or c1=10 or c1=9)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>extra(添加额外的自定义sql语句)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">models.UserInfo.objects.extra(self, select=<span class="literal">None</span>, where=<span class="literal">None</span>, params=<span class="literal">None</span>, tables=<span class="literal">None</span>, order_by=<span class="literal">None</span>, select_params=<span class="literal">None</span>) </span><br><span class="line">a. 映射 </span><br><span class="line">    select </span><br><span class="line">    select_params=<span class="literal">None</span> </span><br><span class="line">    select 此处 <span class="keyword">from</span> 表 </span><br><span class="line"></span><br><span class="line">b. 条件 </span><br><span class="line">    where=<span class="literal">None</span> </span><br><span class="line">    params=<span class="literal">None</span>, </span><br><span class="line">    select * <span class="keyword">from</span> 表 where 此处 </span><br><span class="line"></span><br><span class="line">c. 表 </span><br><span class="line">tables select * <span class="keyword">from</span> 表,此处 </span><br><span class="line"></span><br><span class="line">c. 排序 </span><br><span class="line">order_by=<span class="literal">None</span> </span><br><span class="line">select * <span class="keyword">from</span> 表 order by 此处</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">v = models.UserInfo.objects.<span class="built_in">all</span>().extra( </span><br><span class="line">    select=&#123; </span><br><span class="line">        <span class="string">&#x27;n&#x27;</span>:<span class="string">&quot;select count(1) from app01_usertype where id=%s or id=%s&quot;</span>, </span><br><span class="line">        <span class="string">&#x27;m&#x27;</span>:<span class="string">&quot;select count(1) from app01_usertype where id=%s or id=%s&quot;</span>, </span><br><span class="line">    &#125;, </span><br><span class="line">    select_params=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">) </span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> v: </span><br><span class="line">    print(obj.name,obj.<span class="built_in">id</span>,obj.n) </span><br><span class="line">    ---------- 等价于将查询结果作为字段显示列： </span><br><span class="line"><span class="comment"># select </span></span><br><span class="line"><span class="comment"># id, </span></span><br><span class="line"><span class="comment"># name, </span></span><br><span class="line"><span class="comment"># (select count(1) from tb) as n </span></span><br><span class="line"><span class="comment"># from xb where ....</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">models.UserInfo.objects.extra( </span><br><span class="line">    select=&#123;</span><br><span class="line">        <span class="string">&#x27;newid&#x27;</span>:<span class="string">&#x27;select count(1) from app01_usertype where id&gt;%s&#x27;</span></span><br><span class="line">    &#125;, </span><br><span class="line">    select_params=[<span class="number">1</span>,], </span><br><span class="line">    where = [<span class="string">&#x27;age&gt;%s&#x27;</span>], </span><br><span class="line">    params=[<span class="number">18</span>,], </span><br><span class="line">    order_by=[<span class="string">&#x27;-age&#x27;</span>], </span><br><span class="line">    tables=[<span class="string">&#x27;app01_usertype&#x27;</span>]</span><br><span class="line">) </span><br><span class="line">---------- 等价于原生sql语句如下： </span><br><span class="line">select </span><br><span class="line">    app01_userinfo.<span class="built_in">id</span>, </span><br><span class="line">    (select count(<span class="number">1</span>) <span class="keyword">from</span> app01_usertype where <span class="built_in">id</span>&gt;<span class="number">1</span>) <span class="keyword">as</span> newid </span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">    app01_userinfo,app01_usertype </span><br><span class="line">where </span><br><span class="line">    app01_userinfo.age &gt; <span class="number">18</span> </span><br><span class="line">order by </span><br><span class="line">    app01_userinfo.age </span><br><span class="line">desc</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">result = models.UserInfo.objects.<span class="built_in">filter</span>(id__gt=<span class="number">1</span>).extra( </span><br><span class="line">        where=[<span class="string">&#x27;app01_userinfo.id &lt; %s&#x27;</span>], </span><br><span class="line">        params=[<span class="number">100</span>,], </span><br><span class="line">        tables=[<span class="string">&#x27;app01_usertype&#x27;</span>], </span><br><span class="line">        order_by=[<span class="string">&#x27;-app01_userinfo.id&#x27;</span>], </span><br><span class="line">        select=&#123;</span><br><span class="line">            <span class="string">&#x27;uid&#x27;</span>:<span class="number">1</span>,</span><br><span class="line">            <span class="string">&#x27;sw&#x27;</span>:<span class="string">&quot;select count(1) from app01_userinfo&quot;</span></span><br><span class="line">        &#125; <span class="comment">#添加查询字段 </span></span><br><span class="line">    ) </span><br><span class="line">    ---------- </span><br><span class="line">    SELECT (<span class="number">1</span>) AS <span class="string">&quot;uid&quot;</span>, </span><br><span class="line">        (select count(<span class="number">1</span>) <span class="keyword">from</span> app01_userinfo) AS <span class="string">&quot;sw&quot;</span>, </span><br><span class="line">        <span class="string">&quot;app01_userinfo&quot;</span>.<span class="string">&quot;id&quot;</span>, </span><br><span class="line">        <span class="string">&quot;app01_userinfo&quot;</span>.<span class="string">&quot;name&quot;</span>, </span><br><span class="line">        <span class="string">&quot;app01_userinfo&quot;</span>.<span class="string">&quot;age&quot;</span>, </span><br><span class="line">        <span class="string">&quot;app01_userinfo&quot;</span>.<span class="string">&quot;ut_id&quot;</span> </span><br><span class="line">    FROM </span><br><span class="line">        <span class="string">&quot;app01_userinfo&quot;</span> , </span><br><span class="line">        <span class="string">&quot;app01_usertype&quot;</span> </span><br><span class="line">    WHERE </span><br><span class="line">        (<span class="string">&quot;app01_userinfo&quot;</span>.<span class="string">&quot;id&quot;</span> &gt; <span class="number">1</span> AND (app01_userinfo.<span class="built_in">id</span> &lt; <span class="number">100</span>)) </span><br><span class="line">    ORDER BY </span><br><span class="line">        (<span class="string">&quot;app01_userinfo&quot;</span>.<span class="built_in">id</span>) </span><br><span class="line">    DESC</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>取特定字段值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">v = models.UserInfo.objects.<span class="built_in">all</span>().only(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>) </span><br><span class="line"><span class="comment"># 获取字段以外的字段会再发出第二次sql请求</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>取当前字段以外的所有值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">v = models.UserInfo.objects.<span class="built_in">all</span>().defer(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>反转</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">v = models.UserInfo.objects.<span class="built_in">all</span>().order_by(<span class="string">&#x27;-id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>).reverse() </span><br><span class="line"><span class="comment"># 只有在order_by()方法时才有效果</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>使用数据库引擎</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">models.UserInfo.objects.<span class="built_in">all</span>().using(<span class="string">&#x27;db2&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>聚合</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#统计总数 </span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Count </span><br><span class="line">result = models.UserInfo.objects.aggregate(k=Count(<span class="string">&#x27;ut_id&#x27;</span>, distinct=<span class="literal">True</span>), n=Count(<span class="string">&#x27;id&#x27;</span>)) </span><br><span class="line"><span class="comment"># distinct代表去重 print(ruselt.query())</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以字典格式添加数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">obj = models.UserType.objects.create(**&#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;xxx&#x27;</span>&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以关键字参数添加数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">obj = models.UserType.objects.create(title=<span class="string">&#x27;xxx&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>批量增加数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">objs = [ models.UserInfo(name=<span class="string">&#x27;r11&#x27;</span>), ] </span><br><span class="line">models.UserInfo.objects.bulk_create(objs, <span class="number">10</span>) </span><br><span class="line"><span class="comment"># 10为一次提交10次数据，建议不超过999</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>创建/获取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">obj, created = models.UserInfo.objects.get_or_create( </span><br><span class="line">    <span class="comment">#如果存在数据则获取，否则直接创建 </span></span><br><span class="line">    username=<span class="string">&#x27;root1&#x27;</span>, </span><br><span class="line">    pwd=<span class="string">&#x27;ff&#x27;</span>, </span><br><span class="line">    defaults=&#123;<span class="string">&#x27;email&#x27;</span>: <span class="string">&#x27;1111111&#x27;</span>,<span class="string">&#x27;u_id&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;t_id&#x27;</span>: <span class="number">2</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>条件范围</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">models.UserInfo.objects.in_bulk([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]) </span><br><span class="line"><span class="comment">#根据主键进行查询 相当于</span></span><br><span class="line">models.UserInfo.objects.<span class="built_in">filter</span>(id__in=[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>raw(书写原生sql语句)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">name_map = &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;name&#x27;</span>&#125; </span><br><span class="line"><span class="comment"># 将下面的title转换为name </span></span><br><span class="line">v1 = models.UserInfo.objects.raw(<span class="string">&#x27;SELECT id,title FROM app01_usertype&#x27;</span>,translations=name_map) </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> v1: </span><br><span class="line">    print(i,<span class="built_in">type</span>(i))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>select_related:查询主动做连表，一次性获取所有连表中的数据（性能相关：数据量少的情况下使用）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">q = models.UserInfo.objects.<span class="built_in">all</span>().select_related(<span class="string">&#x27;ut&#x27;</span>,<span class="string">&#x27;gp&#x27;</span>) </span><br><span class="line"><span class="comment">#等价于select * from userinfo inner join usertype on ... for row in q: print(row.name,row.ut.title) </span></span><br><span class="line"><span class="comment">#采用.的形式获取连表数据</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>prefetch_related：不做连表，但会做多次查询（性能相关：数据量多，查询频繁下使用）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">q = models.UserInfo.objects.<span class="built_in">all</span>().prefetch_related(<span class="string">&#x27;ut&#x27;</span>) </span><br><span class="line"><span class="comment"># select * from userinfo; </span></span><br><span class="line"><span class="comment"># Django内部：ut_id = [2,4] </span></span><br><span class="line"><span class="comment"># select * from usertype where id in [2,4] for row in q: print(row.id,row.ut.title)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a14">
<a id="XSS_2863"></a>XSS攻击（跨站脚本攻击）</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">模拟攻击时：前提需要将对应设置注释 MIDDLEWARE = [ </span><br><span class="line"><span class="comment"># &#x27;django.middleware.csrf.CsrfViewMiddleware&#x27;, </span></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^index/&#x27;</span>, views.index), url(<span class="string">r&#x27;^comment/&#x27;</span>, views.comment),</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;comment.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        v = request.POST.get(<span class="string">&#x27;content&#x27;</span>) msg.append(v) </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;comment.html&#x27;</span>) </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;index.html&#x27;</span>,&#123;<span class="string">&#x27;msg&#x27;</span>:msg&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 同时也可在视图函数中添加safe： </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">from</span> django.utils.safestring <span class="keyword">import</span> mark_safe </span><br><span class="line">    temp = <span class="string">&quot;&lt;a href=&#x27;http://www.baidu.com&#x27;&gt;百度&lt;/a&gt;&quot;</span> </span><br><span class="line">    newtemp = mark_safe(temp) </span><br><span class="line">    <span class="comment">#将内容处理成safe安全数据 </span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;test.html&#x27;</span>,&#123;<span class="string">&#x27;temp&#x27;</span>:newtemp&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">黑客可通过伪造网站，进行xss攻击，获得用户访问正式网站中的cookies， 从而伪装该用户可到正式网站进行操作，所以cookies很重要，要xss要处于启动状态（默认xss为启用状态）</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>CSRF(跨站请求伪装攻击)</p>
<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 前提需要setting文件中crsf验证开启 url(r&#x27;^csrf1.html$&#x27;, views.csrf1)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csrf1</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;csrf1.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>补充：csrf第二种处理方式：添加装饰器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View </span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator </span><br><span class="line"><span class="comment"># CBV装饰器，无法将内置的@csrf_protect装饰器直接应用到函数上，而需手动写装饰器进行应用 </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">func</span>):</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span>(<span class="params">*args,**kwargs</span>):</span> </span><br><span class="line">        <span class="keyword">return</span> func(*args,**kwargs) </span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#在指定方法上添加装饰器 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>(<span class="params">View</span>):</span></span><br><span class="line"><span class="meta">    @method_decorator(wrapper) </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span> </span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span> </span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 在类上添加 </span></span><br><span class="line"><span class="meta">@method_decorator(wrapper,name=&#x27;XXX&#x27;) </span></span><br><span class="line"><span class="comment">#name表示应用的函数名称 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span>(<span class="params">View</span>):</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span> </span><br><span class="line">        <span class="keyword">pass</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span> </span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csrf1</span>(<span class="params">request</span>):</span> </span><br><span class="line"><span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;csrf1.html&#x27;</span>) </span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a15">
<a id="ORMhtmlsimple_tag_3031"></a>ORM函数相关（html模版上使用函数）simple_tag</h2>

<p>setting注册程序块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [ …… <span class="string">&#x27;app01&#x27;</span>, ]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>总结:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">- simple_filter - 最多两个参数,格式： &#123;&#123;第一个参数|函数名称:<span class="string">&quot;第二个参数&quot;</span>&#125;&#125; - 可以做条件判断 - simple_tag - 无限制: &#123;% 函数名 参数 参数%&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a16">
<a id="cookiesessionsession_3137"></a>cookie和session（推荐使用session）</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cookie是保存在客户端浏览器上的键值对， Session是保存在服务端的数据（本质是键值对） 因为单独使用cookies，它会保留用户具体的明文形式（不转化成字符串的敏感信息）发送给浏览器（不安全），所以推荐使用session， session发送的是随机字符串，不包含用户敏感信息（安全），其中session依赖于cookies,</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    …… </span><br><span class="line">    url(<span class="string">r&#x27;^login/&#x27;</span>, views.login), </span><br><span class="line">    url(<span class="string">r&#x27;^index/&#x27;</span>, views.index),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        u = request.POST.get(<span class="string">&#x27;user&#x27;</span>) </span><br><span class="line">        p = request.POST.get(<span class="string">&#x27;pwd&#x27;</span>) </span><br><span class="line">        obj = models.UserAdmin.objects.<span class="built_in">filter</span>(username=u,password=p).first() </span><br><span class="line">        <span class="keyword">if</span> obj: </span><br><span class="line">            <span class="comment"># 1. 生成随机字符串 </span></span><br><span class="line">            <span class="comment"># 2. 通过cookie发送给客户端 </span></span><br><span class="line">            <span class="comment"># 3. 服务端保存 </span></span><br><span class="line">            <span class="comment"># &#123; # 随机字符串1: </span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;alex&#x27;</span>,</span><br><span class="line">                    <span class="string">&#x27;email&#x27;</span>:<span class="string">&#x27;x&#x27;</span></span><br><span class="line">                    ...</span><br><span class="line">                &#125; </span><br><span class="line">            <span class="comment"># &#125; request.session[&#x27;username&#x27;] = obj.username </span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">&#x27;/index/&#x27;</span>) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>,&#123;<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;用户名或密码错误&#x27;</span>&#125;) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment"># 获取客户端cookies中的随机字符串，去session中查找有无该字符串， 再通过字符串去session对应key的value中查看是有username，并获得它对应的值 </span></span><br><span class="line">    v = request.session.get(<span class="string">&#x27;username&#x27;</span>) </span><br><span class="line">    <span class="comment"># v为username对应的具体值 </span></span><br><span class="line">    <span class="keyword">if</span> v:   </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;登录成功:%s&#x27;</span> %v) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/login/&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>setting</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># SESSION_COOKIE_NAME = &quot;sessionid&quot; </span></span><br><span class="line"><span class="comment"># Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串 </span></span><br><span class="line"><span class="comment"># SESSION_COOKIE_PATH = &quot;/&quot; </span></span><br><span class="line"><span class="comment"># Session的cookie保存的路径 </span></span><br><span class="line"><span class="comment"># SESSION_COOKIE_DOMAIN = None </span></span><br><span class="line"><span class="comment"># Session的cookie保存的域名 </span></span><br><span class="line"><span class="comment"># SESSION_COOKIE_SECURE = False </span></span><br><span class="line"><span class="comment"># 是否Https传输cookie </span></span><br><span class="line"><span class="comment"># SESSION_COOKIE_HTTPONLY = True </span></span><br><span class="line"><span class="comment"># 是否Session的cookie只支持http传输 </span></span><br><span class="line"><span class="comment"># SESSION_COOKIE_AGE = 1209600 </span></span><br><span class="line"><span class="comment"># Session的cookie失效日期（2周） </span></span><br><span class="line"><span class="comment"># SESSION_EXPIRE_AT_BROWSER_CLOSE = False </span></span><br><span class="line"><span class="comment"># 是否关闭浏览器使得Session过期 </span></span><br><span class="line"><span class="comment"># SESSION_SAVE_EVERY_REQUEST = False（推荐True） </span></span><br><span class="line"><span class="comment"># 是否每次请求都保存Session，默认修改之后才保存 SESSION_ENGINE = &#x27;django.contrib.sessions.backends.cashe&#x27; </span></span><br><span class="line"><span class="comment">#引擎，缓存+数据库，推荐使用 SESSION__CASHE_ALLAS =&#x27;default&#x27; </span></span><br><span class="line"><span class="comment"># 使用缓存别名</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a17">
<a id="demo_3207"></a>用户登陆demo</h2>


<p>models</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db </span><br><span class="line"><span class="keyword">import</span> models </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Boy</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    nickname = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    password = models.CharField(max_length=<span class="number">63</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Girl</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    nickname = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    password = models.CharField(max_length=<span class="number">63</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B2G</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    b = models.ForeignKey(to=<span class="string">&#x27;Boy&#x27;</span>, to_field=<span class="string">&#x27;id&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    g = models.ForeignKey(to=<span class="string">&#x27;Girl&#x27;</span>, to_field=<span class="string">&#x27;id&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    url(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls), </span><br><span class="line">    url(<span class="string">r&#x27;^login.html$&#x27;</span>, account.login), </span><br><span class="line">    url(<span class="string">r&#x27;^index.html$&#x27;</span>, love.index), </span><br><span class="line">    url(<span class="string">r&#x27;^loginout.html$&#x27;</span>,account.loginout), </span><br><span class="line">    url(<span class="string">r&#x27;^others.html$&#x27;</span>,love.others), </span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views(创立文件夹的形式用来区分模块关系)</p>
<p>account模块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponse,redirect </span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment">#  用户登陆 </span></span><br><span class="line">        :param request: </span><br><span class="line">        :<span class="keyword">return</span>: </span><br><span class="line">        </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        user = request.POST.get(<span class="string">&#x27;username&#x27;</span>) </span><br><span class="line">        pwd = request.POST.get(<span class="string">&#x27;password&#x27;</span>) </span><br><span class="line">        gender = request.POST.get(<span class="string">&#x27;gender&#x27;</span>) </span><br><span class="line">        rmb = request.POST.get(<span class="string">&#x27;rmb&#x27;</span>) </span><br><span class="line">    <span class="comment"># 性别判断 </span></span><br><span class="line">    <span class="keyword">if</span> gender == <span class="string">&quot;1&quot;</span>:   </span><br><span class="line">        obj = models.Boy.objects.<span class="built_in">filter</span>(username=user,password=pwd).first() </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        obj = models.Girl.objects.<span class="built_in">filter</span>(username=user,password=pwd).first() </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> obj: </span><br><span class="line">            <span class="comment"># 未登录 </span></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>,&#123;<span class="string">&#x27;msg&#x27;</span>: <span class="string">&#x27;用户名或密码错误&#x27;</span>&#125;) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            request.session[<span class="string">&#x27;user_info&#x27;</span>] = &#123;<span class="string">&#x27;user_id&#x27;</span>:obj.<span class="built_in">id</span>,<span class="string">&#x27;gender&#x27;</span>:gender,<span class="string">&#x27;username&#x27;</span>:user,<span class="string">&#x27;nickname&#x27;</span>:obj.nickname&#125; </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/index.html&#x27;</span>) </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loginout</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment">#  注销 :</span></span><br><span class="line">        param request: </span><br><span class="line">        :<span class="keyword">return</span>: </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    <span class="keyword">if</span> request.session.get(<span class="string">&#x27;user_info&#x27;</span>): </span><br><span class="line">        request.session.clear() </span><br><span class="line"></span><br><span class="line">    <span class="comment"># 清除服务端数据库session（推荐） </span></span><br><span class="line">    <span class="comment"># request.session.delete(request.session.session_key) </span></span><br><span class="line">    <span class="comment">#清除客户端session return redirect(&#x27;/login.html&#x27;)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>love模块</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,redirect,HttpResponse </span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    首页信息展示 </span><br><span class="line">    :param request: </span><br><span class="line">    :<span class="keyword">return</span>: </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request.session.get(<span class="string">&#x27;user_info&#x27;</span>): </span><br><span class="line">        <span class="comment"># 获取浏览器中的session随机字符串 </span></span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/login.html&#x27;</span>) <span class="keyword">else</span>: </span><br><span class="line">        <span class="comment"># 男：女生列表 </span></span><br><span class="line">        <span class="comment"># 女：男生列表 </span></span><br><span class="line">        gender = request.session.get(<span class="string">&#x27;user_info&#x27;</span>).get(<span class="string">&#x27;gender&#x27;</span>) </span><br><span class="line">        <span class="keyword">if</span> gender == <span class="string">&#x27;1&#x27;</span>: </span><br><span class="line">            user_list = models.Girl.objects.<span class="built_in">all</span>() </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            user_list = models.Boy.objects.<span class="built_in">all</span>() </span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;index.html&#x27;</span>,&#123;<span class="string">&#x27;user_list&#x27;</span>:user_list&#125;) </span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">others</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    获取与当前用户有关系的异性 </span><br><span class="line">    :param request: </span><br><span class="line">    :<span class="keyword">return</span>: </span><br><span class="line">    <span class="comment">#  </span></span><br><span class="line">    current_user_id = request.session.get(<span class="string">&#x27;user_info&#x27;</span>).get(<span class="string">&#x27;user_id&#x27;</span>) </span><br><span class="line">    gender = request.session.get(<span class="string">&#x27;user_info&#x27;</span>).get(<span class="string">&#x27;gender&#x27;</span>) </span><br><span class="line">    <span class="keyword">if</span> gender == <span class="string">&#x27;1&#x27;</span>: </span><br><span class="line">        user_list = models.B2G.objects.<span class="built_in">filter</span>(b_id=current_user_id).values(<span class="string">&#x27;g__nickname&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        user_list = models.B2G.objects.<span class="built_in">filter</span>(g_id=current_user_id).values(<span class="string">&#x27;b__nickname&#x27;</span>) </span><br><span class="line">        print(<span class="string">&#x27;result&#x27;</span>, user_list) </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;others.html&#x27;</span>,&#123;<span class="string">&#x27;user_list&#x27;</span>:user_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立html组件：user_header</p>
<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    …… </span><br><span class="line">    url(<span class="string">r&#x27;^login/$&#x27;</span>, views.login), </span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> Form,fields </span><br><span class="line"><span class="comment"># -------定义Form验证规则类 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    <span class="comment"># 正则验证: 不能为空,6-18 </span></span><br><span class="line">    username = fields.CharField( </span><br><span class="line">        max_length=<span class="number">18</span>, </span><br><span class="line">        min_length=<span class="number">6</span>, </span><br><span class="line">        required=<span class="literal">True</span>, </span><br><span class="line">        error_messages=&#123; </span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>: <span class="string">&#x27;用户名不能为空&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;min_length&#x27;</span>: <span class="string">&#x27;太短了&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;max_length&#x27;</span>: <span class="string">&#x27;太长了&#x27;</span>, </span><br><span class="line">        &#125; </span><br><span class="line">    ) </span><br><span class="line">    <span class="comment"># 正则验证: 不能为空，16+ </span></span><br><span class="line">    password = fields.CharField(min_length=<span class="number">16</span>,required=<span class="literal">True</span>) </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">request</span>):</span> </span><br><span class="line">        <span class="comment">#Form表单提交形式 </span></span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            obj = LoginForm(request.POST) </span><br><span class="line">        <span class="comment">#将提交的数据交给Form组件验证 </span></span><br><span class="line">        <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">            <span class="comment"># 用户输入格式正确 </span></span><br><span class="line">            print(obj.cleaned_data) </span><br><span class="line">            <span class="comment"># 字典类型,只包含Form组件校验后的字段数据 </span></span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">&#x27;http://www.baidu.com&#x27;</span>) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="comment"># 用户输入格式错误 </span></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Form验证流程分析</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">第一步：</span><br><span class="line">实例化，将字段转换为self.fields格式 LoginForm实例化时， </span><br><span class="line">self.fields=&#123; <span class="string">&#x27;user&#x27;</span>: 正则表达式 <span class="string">&#x27;pwd&#x27;</span>: 正则表达式 &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">第二步：</span><br><span class="line">循环self.fields，获得字段 </span><br><span class="line">flag = <span class="literal">True</span> errors cleaned_data <span class="keyword">for</span> k,v <span class="keyword">in</span> self.fields.items(): </span><br><span class="line">input_value = request.POST.get(k) </span><br><span class="line"><span class="comment"># 循环获得k字段的值（k需与前端字段名保持一致） </span></span><br><span class="line">校验input_value的值是否匹配正则表达式 </span><br><span class="line">flag = <span class="literal">False</span> <span class="keyword">return</span> flag </span><br><span class="line">--------------------------------------- </span><br><span class="line"><span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">    <span class="comment">#返回结果为True则通过验证 </span></span><br><span class="line">    print(obj.cleaned_data) </span><br><span class="line"><span class="keyword">else</span>: </span><br><span class="line">    print(obj.errors) </span><br><span class="line">    </span><br><span class="line"><span class="keyword">return</span> render(request,<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">…… </span><br><span class="line">url(<span class="string">r&#x27;^ajax_login/&#x27;</span>, views.ajax_login),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    <span class="comment">#定义Form组件类，用来验证请求数据 </span></span><br><span class="line">    user = fields.CharField(required=<span class="literal">True</span>,min_length=<span class="number">6</span>) </span><br><span class="line">    pwd = fields.CharField(min_length=<span class="number">18</span>) </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">ajax_login</span>(<span class="params">request</span>):</span> </span><br><span class="line">        <span class="keyword">import</span> json </span><br><span class="line">        ret=&#123;<span class="string">&#x27;status&#x27;</span>: <span class="literal">True</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="literal">None</span>&#125; </span><br><span class="line">        obj = LoginForm(request.POST) </span><br><span class="line">        <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">            print(obj.cleaned_data) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            ret[<span class="string">&#x27;status&#x27;</span>]=<span class="literal">False</span> </span><br><span class="line">            ret[<span class="string">&#x27;msg&#x27;</span>]=obj.errors </span><br><span class="line">        <span class="comment"># 获得字典，k为字段名，v为错误信息列表 </span></span><br><span class="line">        v=json.dumps(ret) </span><br><span class="line">        print(obj.errors) </span><br><span class="line">        <span class="comment">#print时，会自动调用__str__(),在该方法中将字典组装成了ul标签 </span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(v)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Form组件常用字段及参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    t1 = fields.CharField( </span><br><span class="line">        required=<span class="literal">True</span>, </span><br><span class="line">        max_length=<span class="number">8</span>, </span><br><span class="line">        min_length=<span class="number">2</span>, </span><br><span class="line">        error_messages=&#123; </span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>: <span class="string">&#x27;不能为空&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;max_length&#x27;</span>: <span class="string">&#x27;太长&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;min_length&#x27;</span>: <span class="string">&#x27;太短&#x27;</span>, </span><br><span class="line">        &#125; ) </span><br><span class="line">    t2 = fields.IntegerField( </span><br><span class="line">        min_value=<span class="number">10</span>, </span><br><span class="line">        max_value=<span class="number">1000</span>, </span><br><span class="line">        error_messages=&#123; </span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>: <span class="string">&#x27;t2不能为空&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;invalid&#x27;</span>: <span class="string">&#x27;t2格式错误，必须是数字&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;min_value&#x27;</span>: <span class="string">&#x27;必须大于10&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;max_value&#x27;</span>: <span class="string">&#x27;必须小于1000&#x27;</span>, </span><br><span class="line">        &#125;, ) </span><br><span class="line">    t3 = fields.EmailField( </span><br><span class="line">        error_messages=&#123; </span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>: <span class="string">&#x27;t3不能为空&#x27;</span>, </span><br><span class="line">            <span class="string">&#x27;invalid&#x27;</span>: <span class="string">&#x27;t3格式错误，必须是邮箱格式&#x27;</span>, </span><br><span class="line">        &#125; ) </span><br><span class="line"><span class="comment"># 为空，长度，格式，正则</span></span><br><span class="line">    t4=fields.URLField() </span><br><span class="line">    t5=fields.SlugField() </span><br><span class="line">    t6=fields.GenericIPAddressField() </span><br><span class="line">    t7=fields.DateField() </span><br><span class="line">    t8=fields.DateTimeField() </span><br><span class="line">    t9=fields.RegexField(<span class="string">&#x27;139\d+&#x27;</span>) </span><br><span class="line"><span class="comment"># 自定义正则表达式的字段验证规则</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">生成HTML标签： </span><br><span class="line">widget=widgets.Select, </span><br><span class="line">******** 用于指定生成怎样的HTML，select，text,<span class="built_in">input</span>/. label=<span class="string">&#x27;用户名&#x27;</span>, </span><br><span class="line"><span class="comment"># obj.t1.label disabled=False, </span></span><br><span class="line"><span class="comment"># 是否可以编辑 label_suffix=&#x27;---&gt;&#x27;, </span></span><br><span class="line"><span class="comment"># Label内容后缀 需要在html模版中添加&#123;&#123; obj.as_p &#125;&#125;来显示出所有Form类中定义的字段 initial=&#x27;666&#x27;, </span></span><br><span class="line"><span class="comment"># 无用，猜测有问题应该在input框中显示默认值 help_text=&#x27;。。。。。。&#x27;, </span></span><br><span class="line"><span class="comment"># 提供帮助信息</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^register/&#x27;</span>, views.register),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RegiterForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    user = fields.CharField(min_length=<span class="number">8</span>) </span><br><span class="line">    email = fields.EmailField() </span><br><span class="line">    password = fields.CharField() </span><br><span class="line">    phone = fields.RegexField(<span class="string">&#x27;139\d+&#x27;</span>) </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">request</span>):</span> </span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">            obj = RegiterForm() </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;register.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;) </span><br><span class="line">        <span class="comment"># 只返回表单组件类的HTML文本，无数值返回 </span></span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            obj = RegiterForm(request.POST) </span><br><span class="line">        <span class="comment"># 因用户提交了数据，Form组件会返回带有输入框值的HTML文本 </span></span><br><span class="line">        <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">            print(obj.cleaned_data) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            print(obj.errors) </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;register.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a19">
<a id="Form_3648"></a>Form组件完成学员管理系统</h2>


<p>models</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Classes</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line"><span class="comment">#默认生成id </span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span> </span><br><span class="line"><span class="comment"># 重载方法，打印对象时，打印的内容为对象包含的title属性 </span></span><br><span class="line">        <span class="keyword">return</span> self.title </span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    email = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    age = models.IntegerField(max_length=<span class="number">32</span>) </span><br><span class="line">    cls = models.ForeignKey(<span class="string">&#x27;Classes&#x27;</span>,on_delete=<span class="string">&#x27;&#x27;</span>) </span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Teacher</span>(<span class="params">models.Model</span>):</span> </span><br><span class="line">    tname = models.CharField(max_length=<span class="number">32</span>) </span><br><span class="line">    c2t = models.ManyToManyField(<span class="string">&#x27;Classes&#x27;</span>) </span><br><span class="line"><span class="comment"># 自动生成第3张关联表，表中自动生成两张表的外键关联id</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>班级管理</p>
<p>查</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls url(r&#x27;^class_list/&#x27;,views.class_list),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">class_list</span>(<span class="params">request</span>):</span> </span><br><span class="line">    cls_list = models.Classes.objects.<span class="built_in">all</span>() </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;class_list.html&#x27;</span>,&#123;<span class="string">&#x27;cls_list&#x27;</span>:cls_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls url(r&#x27;^add_class/&#x27;,views.add_class),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    title = fields.RegexField(<span class="string">&#x27;全栈\d+&#x27;</span>) </span><br><span class="line"><span class="comment"># 定义From组件校验规则 </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_class</span>(<span class="params">request</span>):</span> </span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">            obj = ClassForm() </span><br><span class="line">            <span class="comment"># 用Form组件生成表单标签到页面上 </span></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;add_class.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;) </span><br><span class="line">            </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            obj = ClassForm(request.POST) </span><br><span class="line">            <span class="comment"># 通过Form组件进行校验 </span></span><br><span class="line">            <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">                models.Classes.objects.create(**obj.cleaned_data) </span><br><span class="line">                <span class="keyword">return</span> redirect(<span class="string">&#x27;/class_list/&#x27;</span>) </span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">&#x27;add_class.html&#x27;</span>, &#123;<span class="string">&#x27;obj&#x27;</span>: obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls url(r&#x27;edit_class/(\d+)&#x27;,views.edit_class),</span></span><br><span class="line"><span class="comment">#接收任意数字id的正则</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line">…… 省略Form组件定义类 …… </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_class</span>(<span class="params">request, nid</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        row = models.Classes.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=nid).first() </span><br><span class="line">        <span class="comment"># 让页面显示初始值 </span></span><br><span class="line">        <span class="comment"># obj = ClassForm(data=&#123;&#x27;title&#x27;: row.title&#125;) </span></span><br><span class="line">        <span class="comment">#发送到前端时，Form组件会进行校验 </span></span><br><span class="line">        obj = ClassForm(initial=&#123;<span class="string">&#x27;title&#x27;</span>: row.title&#125;) </span><br><span class="line">        <span class="comment">#Form组件不会进行校验</span></span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_class.html&#x27;</span>,&#123;<span class="string">&#x27;nid&#x27;</span>:nid,<span class="string">&#x27;obj&#x27;</span>:obj&#125;) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        obj = ClassForm(request.POST) <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">        <span class="comment"># models.Classes.objects.filter(id=nid).update(title = obj.cleaned_data[&#x27;title&#x27;]) </span></span><br><span class="line">        models.Classes.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=nid).update(**obj.cleaned_data) </span><br><span class="line">        <span class="comment"># 以字典格式插入数据 </span></span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&#x27;/class_list/&#x27;</span>) </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_class.html&#x27;</span>,&#123;<span class="string">&#x27;nid&#x27;</span>: nid,<span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>学生管理</p>
<p>查</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls url(r&#x27;^student_list/&#x27;, views.student_list),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">student_list</span>(<span class="params">request</span>):</span> </span><br><span class="line">    stu_list = models.Student.objects.<span class="built_in">all</span>() </span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;student_list.html&#x27;</span>, &#123;<span class="string">&#x27;stu_list&#x27;</span>:stu_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># urls url(r&#x27;add_student/&#x27;, views.add_student),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views # Form组件定义： </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    name = fields.CharField( </span><br><span class="line">        min_length=<span class="number">2</span>, </span><br><span class="line">        max_length=<span class="number">6</span>, </span><br><span class="line">        widget=widgets.TextInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;) <span class="comment">#表单组件样式选择及属性设置，默认组件样式为text文本框 </span></span><br><span class="line">    ) </span><br><span class="line">    email = fields.EmailField(</span><br><span class="line">        widget=widgets.TextInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;)</span><br><span class="line">    ) </span><br><span class="line">    age = fields.IntegerField(</span><br><span class="line">        min_value=<span class="number">18</span>,</span><br><span class="line">        max_value=<span class="number">25</span>,</span><br><span class="line">        widget=widgets.TextInput(attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;)</span><br><span class="line">    ) </span><br><span class="line">    cls_id = fields.IntegerField( <span class="comment"># widget=widgets.Select(choices=[(1,&#x27;上海&#x27;),(2,&#x27;北京&#x27;)]) </span></span><br><span class="line">        widget=widgets.Select(</span><br><span class="line">            choices=models.Classes.objects.values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>),</span><br><span class="line">            attrs=&#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;form-control&#x27;</span>&#125;</span><br><span class="line">        ) <span class="comment"># 获得单选下拉框 </span></span><br><span class="line">        <span class="comment"># 另外一种写法：</span></span><br><span class="line">    cls_id=fields.ChoiceField( </span><br><span class="line">        choices = models.Class.objests.values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">        widget = widgets.Select(attr=&#123;<span class="string">&#x27;class&#x27;</span>:<span class="string">&#x27;&#x27;</span>form-control&#125;) ) </span><br><span class="line">    ) </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_student</span>(<span class="params">request</span>):</span> </span><br><span class="line">        <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">            obj = StudentForm() </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;add_student.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            obj = StudentForm(request.POST) </span><br><span class="line">            <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">                models.Student.objects.create(**obj.cleaned_data) </span><br><span class="line">                <span class="keyword">return</span> redirect(<span class="string">&#x27;/student_list/&#x27;</span>) </span><br><span class="line">            <span class="keyword">else</span>: </span><br><span class="line">                <span class="keyword">return</span> render(request,<span class="string">&#x27;add_student.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># urls url(r&#x27;^edit_student/(\d+)/&#x27;, views.edit_student),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line">……省略Form组件…… </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_student</span>(<span class="params">request,nid</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        row = models.Student.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=nid).values(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;email&#x27;</span>,<span class="string">&#x27;age&#x27;</span>,<span class="string">&#x27;cls_id&#x27;</span>).first() </span><br><span class="line">        <span class="comment">#如果不添加first会报错，错误为“要解压的值太多” </span></span><br><span class="line">        obj = StudentForm(initial=row) </span><br><span class="line">        <span class="comment"># 将数据封装至Form组件中，initial设置为不做数据验证 </span></span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_student.html&#x27;</span>,&#123;<span class="string">&#x27;nid&#x27;</span>:nid, <span class="string">&#x27;obj&#x27;</span>:obj&#125;) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        obj = StudentForm(request.POST) </span><br><span class="line">        <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">            models.Student.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=nid).update(**obj.cleaned_data) </span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">&#x27;/student_list/&#x27;</span>) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;/edit_student.html&#x27;</span>,&#123;<span class="string">&#x27;nid&#x27;</span>:<span class="built_in">id</span>, <span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>老师管理</p>
<p>查</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># urls url(r&#x27;^teacher_list/&#x27;, views.teacher_list),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">teacher_list</span>(<span class="params">request</span>):</span> </span><br><span class="line">    tea_list = models.Teacher.objects.<span class="built_in">all</span>() </span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;teacher_list.html&#x27;</span>,&#123;<span class="string">&#x27;tea_list&#x27;</span>:tea_list&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># urls url(r&#x27;^add_teacher/&#x27;, views.add_teacher),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views #Form组件定义：（实现数据动态显示） </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TeacherForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    tname=fields.CharField(min_length=<span class="number">2</span>) </span><br><span class="line">    cls_id = fields.MultipleChoiceField( </span><br><span class="line">        <span class="comment">#　多选模式，过滤出字典中包含的是列表格式数据&#123;&#x27;cls_id&#x27;: [&#x27;2&#x27;, &#x27;3&#x27;]&#125;，而非列表字符串格式&#123;&#x27;cls_id&#x27;: “[&#x27;2&#x27;, &#x27;3&#x27;]”&#125; </span></span><br><span class="line">        <span class="comment"># choices=models.Classes.objects.values_list(&#x27;id&#x27;,&#x27;title&#x27;), </span></span><br><span class="line">        <span class="comment"># 生成下拉框对应的值，有了__init__()构造方法后可以不用写choices关键字参数 widget=widgets.SelectMultiple </span></span><br><span class="line">        <span class="comment"># 多选下拉框表单组件 </span></span><br><span class="line">    ) </span><br><span class="line">    <span class="comment">#因From组件对象不会重新启动获得数据库的值， #所以需要每一次类加载实例化的构造方法来重新获取数据库的值,实现数据动态显示 </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,*args,**kwargs</span>):</span> </span><br><span class="line">        <span class="built_in">super</span>(TeacherForm,self).__init__(*args,**kwargs) </span><br><span class="line">        <span class="comment"># 调用父类构造方法 </span></span><br><span class="line">        self.fields[<span class="string">&#x27;cls_id&#x27;</span>].widget.choices=models.Classes.objects.values_list(<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;title&#x27;</span>) </span><br><span class="line">        <span class="comment"># 获得字典中字段的插件widget中的choices </span></span><br><span class="line">        <span class="comment"># Form组件执行方式 </span></span><br><span class="line">        <span class="comment"># obj = TeacherForm() </span></span><br><span class="line">        <span class="comment"># 1. 找到所有字段 </span></span><br><span class="line">        <span class="comment"># 2. self.fields = &#123; </span></span><br><span class="line">            <span class="comment"># 加载字典中的所有字段 </span></span><br><span class="line">            <span class="comment"># tname: fields.CharField(min_length=2) </span></span><br><span class="line">            <span class="comment"># &#125; </span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">add_teacher</span>(<span class="params">request</span>):</span> </span><br><span class="line">        <span class="keyword">if</span> request == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">            obj = TeacherForm() <span class="keyword">return</span> render(request,<span class="string">&#x27;add_teacher.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;) </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            obj = TeacherForm(request.POST) </span><br><span class="line">            <span class="keyword">if</span> obj.is_valid(): </span><br><span class="line">                cls_id= obj.cleaned_data.pop(<span class="string">&#x27;cls_id&#x27;</span>) </span><br><span class="line">                <span class="comment"># 单独提取出cls_id的值 </span></span><br><span class="line">                row = models.Teacher.objects.create(**obj.cleaned_data) </span><br><span class="line">                <span class="comment"># **字典,会自动将字典格式&#123;&#x27;tname&#x27;: &#x27;tom&#x27;&#125;转换成tname=&#x27;tom&#x27;格式的数据 </span></span><br><span class="line">                row.c2t.add(*cls_id) </span><br><span class="line">                <span class="comment"># *代表列表格式插入 </span></span><br><span class="line">                <span class="keyword">return</span> redirect(<span class="string">&#x27;/teacher_list/&#x27;</span>) </span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">&#x27;add_teacher.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>改</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># urls url(r&#x27;^edit_teacher/(\d+)/&#x27;, views.edit_teacher),</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># views </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_teacher</span>(<span class="params">request,nid</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&quot;GET&quot;</span>: </span><br><span class="line">        row = models.Teacher.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=nid).first() </span><br><span class="line">        class_ids = row.c2t.values_list(<span class="string">&#x27;id&#x27;</span>) </span><br><span class="line">        <span class="comment">#获得关联的班级id,值为[(3,),(1,)] </span></span><br><span class="line">        <span class="comment"># zip()将[(3,),(1,)]转换为[（3，1),] </span></span><br><span class="line">        id_list = <span class="built_in">list</span>(<span class="built_in">zip</span>(*class_ids))[<span class="number">0</span>] </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">list</span>(<span class="built_in">zip</span>(*class_ids)) <span class="keyword">else</span> [] </span><br><span class="line">        <span class="comment"># obj = TeacherForm(initial=&#123;&#x27;tname&#x27;:row.tname,&#x27;xx&#x27;:[1,2,3]&#125;) </span></span><br><span class="line">        obj = TeacherForm(initial=&#123;<span class="string">&#x27;tname&#x27;</span>:row.tname,<span class="string">&#x27;cls_id&#x27;</span>:id_list&#125;) </span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">&#x27;edit_teacher.html&#x27;</span>,&#123;<span class="string">&#x27;obj&#x27;</span>:obj&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a20">
<a id="Form_4101"></a>Form常用组件定制</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    t1 = fields.MultipleChoiceField(  <span class="comment"># 验证多选框的值 </span></span><br><span class="line">        choices =[(<span class="number">1</span>,<span class="string">&#x27;篮球&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;足球&#x27;</span>)],  <span class="comment"># 制定显示值 </span></span><br><span class="line">        widget=widgets.CheckboxSelectMultiple  <span class="comment"># 生成多选框组件 </span></span><br><span class="line">    ) </span><br><span class="line">    t2 =fields.MultipleChoiceField( </span><br><span class="line">        choices=[(<span class="number">1</span>,<span class="string">&#x27;篮球&#x27;</span>),(<span class="number">2</span>,<span class="string">&#x27;足球&#x27;</span>)], </span><br><span class="line">        widget=widgets.RadioSelect  <span class="comment"># 单选按钮组件 </span></span><br><span class="line">    ) </span><br><span class="line">    t3 = fields.FileField( </span><br><span class="line">        widget=widgets.FileInput  <span class="comment"># 文件输入框 </span></span><br><span class="line">    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a21">
<a id="Form_4121"></a>Form组件中的钩子（扩展自定义函数）</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestForm</span>(<span class="params">Form</span>):</span> </span><br><span class="line">    user = fields.CharField( <span class="comment"># 添加自定义正则表达式 </span></span><br><span class="line">        validators=[RegexValidator(<span class="string">r&#x27;^[0-9]+$&#x27;</span>, <span class="string">&#x27;请输入数字&#x27;</span>), </span><br><span class="line">        RegexValidator(<span class="string">r&#x27;^159[0-9]+$&#x27;</span>, <span class="string">&#x27;数字必须以159开头&#x27;</span>)],</span><br><span class="line">    ) </span><br><span class="line">    email = fields.EmailField() </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_user</span>(<span class="params">self</span>):</span> </span><br><span class="line">        <span class="comment"># 常用于扩展用户名是否在数据库中存在,验证码是否匹配，传参request </span></span><br><span class="line">        v = self.cleaned_data[<span class="string">&#x27;user&#x27;</span>] </span><br><span class="line">        <span class="keyword">if</span> models.Student.<span class="built_in">object</span>.<span class="built_in">filter</span>(name=v).count(): </span><br><span class="line">            <span class="keyword">raise</span> ValuedationError(<span class="string">&#x27;用户已存在&#x27;</span>) </span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data[<span class="string">&#x27;user&#x27;</span>]</span><br><span class="line">            </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span>(<span class="params">self</span>):</span> </span><br><span class="line">        <span class="comment"># 常用于字段的联合唯一判断 </span></span><br><span class="line">        user=self.cleaned_data.get(<span class="string">&#x27;user&#x27;</span>) </span><br><span class="line">        email=self.cleaned_data.get(<span class="string">&#x27;email&#x27;</span>) </span><br><span class="line">        <span class="keyword">if</span> models.Stuent.objects.<span class="built_in">filter</span>(user=user,email=email).count(): </span><br><span class="line">            <span class="keyword">raise</span> ValuedationError(<span class="string">&#x27;用户名和邮箱联合已经存在&#x27;</span>) </span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a22">
<a id="Ajax_4147"></a>Ajax提交数据部分</h2>

<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> os </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;GET&#x27;</span>: </span><br><span class="line">        <span class="keyword">return</span> render(request, <span class="string">&#x27;upload.html&#x27;</span>) </span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        file_obj = request.FILES.get(<span class="string">&#x27;fafafa&#x27;</span>) </span><br><span class="line">        <span class="comment"># 获得浏览器发送的文件 </span></span><br><span class="line">        file_path = os.path.join(<span class="string">&#x27;static&#x27;</span>, file_obj.name) </span><br><span class="line">        <span class="comment"># 组装文件路径 </span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f: </span><br><span class="line">        <span class="keyword">for</span> chunk <span class="keyword">in</span> file_obj.chunks(): </span><br><span class="line">        <span class="comment"># 把文件块以字节的形式写入文件 </span></span><br><span class="line">            f.write(chunk) </span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> HttpResponse(file_path)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>自定义API用作返回数据</p>
<p>urls</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^users/&#x27;</span>, views.users),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>views</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">users</span>(<span class="params">request</span>):</span> </span><br><span class="line">    print(<span class="string">&#x27;请求到来&#x27;</span>) </span><br><span class="line">    callback = request.GET.get(<span class="string">&#x27;funcname&#x27;</span>) </span><br><span class="line">    user_list=[ <span class="string">&#x27;leo&#x27;</span>, <span class="string">&#x27;tom&#x27;</span>, <span class="string">&#x27;jack&#x27;</span> ] </span><br><span class="line">    temp = <span class="string">&#x27;%s(%s)&#x27;</span>%(callback, user_list) </span><br><span class="line">    print(temp) </span><br><span class="line">    <span class="comment"># return HttpResponse(json.dumps(user_list)) </span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(temp) </span><br><span class="line">    <span class="comment"># 返回一个字符串对象</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>setting配置‘</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;www.s4.com&#x27;</span>] </span><br><span class="line"><span class="comment"># 允许访问的主机</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>本地PC配置</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">C:\Windows\System32\drivers\etc 往hosts文件中添加内容：<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> www.s4.com</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="a230">
<a id="CORS_4456"></a>CORS解决跨域问题（跨来源资源共享）（响应头添加值）</h2>


<p>第三方服务器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r&#x27;^new_users/&#x27;</span>, views.new_users),</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_users</span>(<span class="params">request</span>):</span> </span><br><span class="line">    user_list = [ <span class="string">&#x27;lleo&#x27;</span>, <span class="string">&#x27;tom&#x27;</span>, <span class="string">&#x27;jack&#x27;</span> ] </span><br><span class="line">    obj = HttpResponse(json.dumps(user_list)) </span><br><span class="line">    <span class="comment"># 添加令牌，添加响应头信息 </span></span><br><span class="line">    obj[<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>]=<span class="string">&#x27;http://www.s5.com:8000&#x27;</span> </span><br><span class="line">    <span class="comment"># 允许跨站的数据响应返回，浏览器不设阻拦 </span></span><br><span class="line">    <span class="comment"># obj[&quot;Access-Control-Allow-Origin&quot;]=”*“ print(&#x27;请求&#x27;) </span></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>复杂请求</p>
<p>第三方服务器</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># 复杂请求的处理 </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_users</span>(<span class="params">request</span>):</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;OPTIONS&#x27;</span>: </span><br><span class="line">        obj = HttpResponse() </span><br><span class="line">        obj[<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>] =<span class="string">&#x27;*&#x27;</span> </span><br><span class="line">        obj[<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>] =<span class="string">&#x27;DELETE&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> obj </span><br><span class="line">    </span><br><span class="line">    obj = HttpResponse(<span class="string">&#x27;adsf&#x27;</span>) </span><br><span class="line">    obj[<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>] = <span class="string">&#x27;*&#x27;</span> </span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">雪人</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.webq.top/2020/11/19/doc/dj/">https://www.webq.top/2020/11/19/doc/dj/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.webq.top" target="_blank">雪人</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/hy.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/11/19/doc/dp/"><img class="prev-cover" src="/img/hy.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">设计模式</div></div></a></div><div class="next-post pull-right"><a href="/2020/11/19/doc/ci/"><img class="next-cover" src="/img/hy.jpeg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Gitlab CI/CD管道配置参考</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By 雪人</div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.spacingElementById('content-inner')
  else {
    $.getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js', () => {
      pangu.spacingElementById('content-inner')
    })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguFn)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div></div></body></html>